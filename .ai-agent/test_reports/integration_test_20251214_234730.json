{
  "metadata": {
    "timestamp": "2025-12-14T23:47:30.778483",
    "project_dir": "C:\\Users\\Admin\\AI_Assistant_Pro",
    "user_query": "# –ó–ê–î–ê–ß–ê: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è app/history/compressor.py–í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–∞ `compressor.py` –µ—Å—Ç—å –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –µ–≥–æ –Ω–µ—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω—ã–º.**–ò—Å–ø—Ä–∞–≤—å —Å–ª–µ–¥—É—é—â–∏–µ –ø—É–Ω–∫—Ç—ã (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):**1.  üî¥ **–£–î–ê–õ–ò–¢–¨ –ö–û–î –í –ö–û–ù–¶–ï –§–ê–ô–õ–ê:**    –£–¥–∞–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è `await compress_history_if_needed(...)` –∏ `prune_irrelevant_context(...)` –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ. –≠—Ç–æ –ª–æ–º–∞–µ—Ç –∏–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è.2.  üî¥ **–ò–ó–ú–ï–ù–ò–¢–¨ –î–ï–§–û–õ–¢–ù–´–ô –ü–û–†–û–ì:**    –í —Ñ—É–Ω–∫—Ü–∏–∏ `compress_history_if_needed` —É—Å—Ç–∞–Ω–æ–≤–∏ `threshold: int = 30000` (–≤–º–µ—Å—Ç–æ 8000).3.  üî¥ **–ü–ï–†–ï–ü–ò–°–ê–¢–¨ `prune_irrelevant_context`:**    *   –ò—Å–ø–æ–ª—å–∑—É–π —É–ª—É—á—à–µ–Ω–Ω—ã–π regex –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤:        `r'[\\w/\\-]+\\.(?:py|js|ts|sql|json|md|txt|html|css|go|java|cpp|c|rs|rb)|\\b(?:src|lib|app|tests|config)/[\\w/.-]+'`    *   –ê–ª–≥–æ—Ä–∏—Ç–º:        1. –ù–∞–π—Ç–∏ —Ñ–∞–π–ª—ã –≤ `current_query` (`mentioned_files`).        2. –ï—Å–ª–∏ `mentioned_files` –ø—É—Å—Ç–æ ‚Äî –≤–µ—Ä–Ω—É—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–∞–∫ –µ—Å—Ç—å.        3. –ü—Ä–æ–π—Ç–∏ –ø–æ `role='tool'`.        4. –ù–∞–π—Ç–∏ —Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ `msg.content` (`content_files`).        5. –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:           * –ï—Å–ª–∏ `content_files` –ù–ï –ø—É—Å—Ç –ò –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ `content_files` —Å `mentioned_files` –ü–£–°–¢–û ‚Üí –∑–Ω–∞—á–∏—Ç, —ç—Ç–æ –º—É—Å–æ—Ä.           * –ó–∞–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ `[PRUNED: {file} –±—ã–ª –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ]`.           * –ò–Ω–∞—á–µ (–µ—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ –Ω—É–∂–Ω—ã) ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.4.  üî¥ **–î–û–ë–ê–í–ò–¢–¨ –õ–û–ì–ò–†–û–í–ê–ù–ò–ï:**    –í `compress_history_if_needed` –¥–æ–±–∞–≤—å –ª–æ–≥ –ø—Ä–∏ –ø—Ä–æ–ø—É—Å–∫–µ —Å–∂–∞—Ç–∏—è –∏–∑-–∑–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–¥–∞:    `logger.debug(f\"Skipping compression for assistant message {msg.id} due to code block\")`**–í—ã–¥–∞–π –ü–û–õ–ù–´–ô –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ —Ñ–∞–π–ª–∞ `compressor.py`.**",
    "duration_seconds": 109.6193482875824,
    "models_used": {
      "orchestrator": "Claude Opus 4.5 (RouterAI)",
      "code_generator": "deepseek-chat"
    }
  },
  "orchestrator": {
    "analysis": "–í —Ñ–∞–π–ª–µ `app/history/compressor.py` –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:\n\n1. **–°—Ç—Ä–æ–∫–∏ 188-190**: –ù–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è `await compress_history_if_needed(...)` –∏ `prune_irrelevant_context(...)`. –≠—Ç–æ –ª–æ–º–∞–µ—Ç –∏–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è, —Ç–∞–∫ –∫–∞–∫:\n   - `await` –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω–µ async-—Ñ—É–Ω–∫—Ü–∏–∏\n   - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `history` –∏ `current_query` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ\n\n2. **–°—Ç—Ä–æ–∫–∞ 38**: –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø–æ—Ä–æ–≥ `threshold: int = 8000` —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π, –Ω—É–∂–Ω–æ `30000`.\n\n3. **–§—É–Ω–∫—Ü–∏—è `prune_irrelevant_context` (—Å—Ç—Ä–æ–∫–∏ 143-186)**: \n   - –¢–µ–∫—É—â–∏–π regex —Å–ª–∏—à–∫–æ–º –ø—Ä–æ—Å—Ç–æ–π –∏ –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è\n   - –õ–æ–≥–∏–∫–∞ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞: —Å–µ–π—á–∞—Å –æ–Ω–∞ –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ —Ñ–∞–π–ª—ã –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ, –Ω–æ –Ω—É–∂–Ω–æ –Ω–∞–æ–±–æ—Ä–æ—Ç ‚Äî —É–¥–∞–ª—è—Ç—å, –µ—Å–ª–∏ —Ñ–∞–π–ª—ã –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ –ù–ï –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è —Å —Ñ–∞–π–ª–∞–º–∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞\n\n4. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í `compress_history_if_needed` –ø—Ä–∏ –ø—Ä–æ–ø—É—Å–∫–µ —Å–∂–∞—Ç–∏—è –∏–∑-–∑–∞ –±–ª–æ–∫–∞ –∫–æ–¥–∞ –Ω–µ—Ç debug-–ª–æ–≥–∞.",
    "instruction": "**Task:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ compressor.py: —É–¥–∞–ª–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã, –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä–æ–≥, –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å prune_irrelevant_context —Å –Ω–æ–≤—ã–º regex –∏ –ª–æ–≥–∏–∫–æ–π, –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.\n\n**File:** `app/history/compressor.py`\n\n**Location:** –í–µ—Å—å —Ñ–∞–π–ª —Ç—Ä–µ–±—É–µ—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏\n\n**Changes:**\n\n1. **–£–î–ê–õ–ò–¢–¨ —Å—Ç—Ä–æ–∫–∏ 188-190** (–∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞):\n   –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏:\n   ```python\n   compressed_history = await compress_history_if_needed(history, threshold=8000)\n   pruned_history = prune_irrelevant_context(history, current_query)\n   ```\n   –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–æ–∫–µ 186 (–∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ `prune_irrelevant_context`).\n\n2. **–ò–ó–ú–ï–ù–ò–¢–¨ —Å—Ç—Ä–æ–∫—É 38** ‚Äî —Å–∏–≥–Ω–∞—Ç—É—Ä—É —Ñ—É–Ω–∫—Ü–∏–∏ `compress_history_if_needed`:\n   –ó–∞–º–µ–Ω–∏—Ç—å:\n   ```python\n   async def compress_history_if_needed(history: List[Message], threshold: int = 8000) -> List[Message]:\n   ```\n   –ù–∞:\n   ```python\n   async def compress_history_if_needed(history: List[Message], threshold: int = 30000) -> List[Message]:\n   ```\n\n3. **–ò–ó–ú–ï–ù–ò–¢–¨ —Å—Ç—Ä–æ–∫—É 45** ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å docstring:\n   –ó–∞–º–µ–Ω–∏—Ç—å:\n   ```python\n   threshold: –ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Å–∂–∞—Ç–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 8000).\n   ```\n   –ù–∞:\n   ```python\n   threshold: –ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Å–∂–∞—Ç–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30000).\n   ```\n\n4. **–î–û–ë–ê–í–ò–¢–¨ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±–ª–æ–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ assistant-—Å–æ–æ–±—â–µ–Ω–∏–π** (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 67):\n   –í —Ñ—É–Ω–∫—Ü–∏–∏ `compress_history_if_needed`, –≤ —Ü–∏–∫–ª–µ `for msg in to_compress:`, –≤ –≤–µ—Ç–∫–µ `elif msg.role == 'assistant':`, –ü–ï–†–ï–î –≤—ã–∑–æ–≤–æ–º `_compress_message` –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º:\n   ```python\n   elif msg.role == 'assistant':\n       if _contains_code_block(msg.content):\n           logger.debug(f\"Skipping compression for assistant message {msg.id} due to code block\")\n           compressed_history.append(msg)\n       else:\n           compressed_msg = await _compress_message(msg, \"reasoning\")\n           compressed_history.append(compressed_msg)\n   ```\n   –≠—Ç–æ –∑–∞–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–µ —Å—Ç—Ä–æ–∫–∏ 67-69.\n\n5. **–ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–ü–ò–°–ê–¢–¨ —Ñ—É–Ω–∫—Ü–∏—é `prune_irrelevant_context`** (—Å—Ç—Ä–æ–∫–∏ 143-186):\n   –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å—é —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é:\n\n   ```python\n   def prune_irrelevant_context(history: List[Message], current_query: str) -> List[Message]:\n       \"\"\"\n       –£–¥–∞–ª—è–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–π–ª–æ–≤,\n       —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –≤ —Ç–µ–∫—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ.\n\n       Args:\n           history: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.\n           current_query: –¢–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n       Returns:\n           –ò—Å—Ç–æ—Ä–∏—è —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º–∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.\n       \"\"\"\n       # –£–ª—É—á—à–µ–Ω–Ω—ã–π regex –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤\n       file_pattern = r'[\\w/\\-]+\\.(?:py|js|ts|sql|json|md|txt|html|css|go|java|cpp|c|rs|rb)|\\b(?:src|lib|app|tests|config)/[\\w/.-]+'\n       \n       # –ò–∑–≤–ª–µ–∫–∞–µ–º —É–ø–æ–º—è–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞\n       mentioned_files = set(re.findall(file_pattern, current_query))\n       \n       # –ï—Å–ª–∏ —Ñ–∞–π–ª—ã –Ω–µ —É–ø–æ–º—è–Ω—É—Ç—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π\n       if not mentioned_files:\n           return history\n       \n       pruned_history = []\n       \n       for msg in history:\n           if msg.role != 'tool':\n               pruned_history.append(msg)\n           else:\n               # –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è\n               content_files = set(re.findall(file_pattern, msg.content))\n               \n               # –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:\n               # –ï—Å–ª–∏ content_files –ù–ï –ø—É—Å—Ç –ò –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å mentioned_files –ü–£–°–¢–û ‚Üí —ç—Ç–æ –º—É—Å–æ—Ä\n               if content_files and not content_files.intersection(mentioned_files):\n                   # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è\n                   first_file = next(iter(content_files), \"unknown\")\n                   pruned_content = f\"[PRUNED: {first_file} –±—ã–ª –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ]\"\n                   pruned_msg = Message(\n                       id=msg.id,\n                       thread_id=msg.thread_id,\n                       role=msg.role,\n                       content=pruned_content,\n                       tokens=TokenCounter().count(pruned_content),\n                       metadata=msg.metadata,\n                       created_at=msg.created_at\n                   )\n                   pruned_history.append(pruned_msg)\n               else:\n                   # –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ –Ω—É–∂–Ω—ã ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\n                   pruned_history.append(msg)\n       \n       return pruned_history\n   ```\n\n**Why:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª—è:\n- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã async-—Ñ—É–Ω–∫—Ü–∏–π –ª–æ–º–∞—é—Ç –∏–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è\n- –ü–æ—Ä–æ–≥ 8000 —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤\n- –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ prune_irrelevant_context –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç\n- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –ø—Ä–æ–ø—É—Å–∫ —Å–∂–∞—Ç–∏—è"
  },
  "code_generator": {
    "code_blocks": [
      {
        "filepath": "app/history/compressor.py",
        "language": "python",
        "code": "\"\"\"\n–ú–æ–¥—É–ª—å –¥–ª—è —Å–∂–∞—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ –ª–µ—Ç—É –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î (—Ä–µ–∂–∏–º Recompute).\n–†–µ–∞–ª–∏–∑—É–µ—Ç –¥–≤–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:\n1. –¢–æ–∫–µ–Ω-–±–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ: —Å–∂–∏–º–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é LLM,\n   —Å–æ—Ö—Ä–∞–Ω—è—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–ª–æ–∫–∏ –∫–æ–¥–∞.\n2. –û–±—Ä–µ–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: —É–¥–∞–ª—è–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.\n\"\"\"\n\nimport asyncio\nimport logging\nimport re\nfrom typing import List, Optional\nfrom dataclasses import dataclass\nfrom app.llm.prompt_templates import format_compression_prompt\nfrom app.history.storage import Message\nfrom app.utils.token_counter import TokenCounter\nfrom app.llm.api_client import call_llm\nfrom config.settings import cfg\n\nlogger = logging.getLogger(__name__)\n\n\ndef _contains_code_block(content: str) -> bool:\n    \"\"\"\n    –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –±–ª–æ–∫–∏ –∫–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown (—Ç—Ä–æ–π–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏).\n    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç chr(96)*3 –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–∞–≤—ã—á–µ–∫ –≤ –∫–æ–¥–µ.\n\n    Args:\n        content: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.\n\n    Returns:\n        True, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –±–ª–æ–∫–∏ –∫–æ–¥–∞, –∏–Ω–∞—á–µ False.\n    \"\"\"\n    triple_backticks = chr(96) * 3\n    return triple_backticks in content\n\n\nasync def compress_history_if_needed(history: List[Message], threshold: int = 30000) -> List[Message]:\n    \"\"\"\n    –°–∂–∏–º–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.\n    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏, –∞ —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–∂–∏–º–∞–µ—Ç —Å –ø–æ–º–æ—â—å—é LLM.\n\n    Args:\n        history: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.\n        threshold: –ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Å–∂–∞—Ç–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30000).\n\n    Returns:\n        –°–∂–∞—Ç—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ —Å–∂–∞—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.\n    \"\"\"\n    token_counter = TokenCounter()\n    total_tokens = sum(token_counter.count(msg.content) for msg in history)\n    \n    if total_tokens <= threshold:\n        return history\n    \n    compressed_history = []\n    keep_last_n = 3\n    \n    # –†–∞–∑–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —á–∞—Å—Ç—å –¥–ª—è —Å–∂–∞—Ç–∏—è –∏ —á–∞—Å—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è\n    to_compress = history[:-keep_last_n] if len(history) > keep_last_n else []\n    keep_intact = history[-keep_last_n:] if len(history) > keep_last_n else history\n    \n    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Å–∂–∞—Ç–∏—è\n    for msg in to_compress:\n        if msg.role == 'user':\n            compressed_history.append(msg)\n        elif msg.role == 'assistant':\n            if _contains_code_block(msg.content):\n                logger.debug(f\"Skipping compression for assistant message {msg.id} due to code block\")\n                compressed_history.append(msg)\n            else:\n                compressed_msg = await _compress_message(msg, \"reasoning\")\n                compressed_history.append(compressed_msg)\n        elif msg.role == 'tool':\n            compressed_msg = await _compress_message(msg, \"tool_result\")\n            compressed_history.append(compressed_msg)\n        else:\n            compressed_history.append(msg)\n    \n    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n    compressed_history.extend(keep_intact)\n    \n    # –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∂–∞—Ç–∏—è\n    compressed_tokens = sum(token_counter.count(msg.content) for msg in compressed_history)\n    logger.info(f\"History compressed: {total_tokens} ‚Üí {compressed_tokens} tokens \"\n                f\"({compressed_tokens/total_tokens*100:.1f}% of original)\")\n    \n    return compressed_history\n\n\nasync def _compress_message(msg: Message, content_type: str) -> Message:\n    \"\"\"\n    –°–∂–∏–º–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é LLM, –∏—Å–ø–æ–ª—å–∑—É—è —à–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤.\n    –ù–µ —Å–∂–∏–º–∞–µ—Ç —É–∂–µ —Å–∂–∞—Ç—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–ª–æ–∫–∞–º–∏ –∫–æ–¥–∞.\n\n    Args:\n        msg: –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Å–∂–∞—Ç–∏—è.\n        content_type: –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ('reasoning' –∏–ª–∏ 'tool_result').\n\n    Returns:\n        –°–∂–∞—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.\n    \"\"\"\n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–∂–∞—Ç–æ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ\n    if msg.content.startswith(\"[COMPRESSED]\"):\n        return msg\n    \n    # –ù–µ —Å–∂–∏–º–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–ª–æ–∫–∞–º–∏ –∫–æ–¥–∞\n    if _contains_code_block(msg.content):\n        return msg\n    \n    try:\n        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–∂–∞—Ç–∏—è\n        prompt = format_compression_prompt(msg.content, content_type)\n        \n        # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª—å –¥–ª—è —Å–∂–∞—Ç–∏—è\n        model = cfg.AGENT_MODELS.get(\"history_compressor\", \"deepseek/deepseek-chat\")\n        \n        # –í—ã–∑—ã–≤–∞–µ–º LLM –¥–ª—è —Å–∂–∞—Ç–∏—è\n        compressed = await call_llm(\n            model=model,\n            messages=[{\"role\": \"user\", \"content\": prompt}],\n            temperature=0.0,\n            max_tokens=2000\n        )\n        \n        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–∂–∞—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n        compressed_content = \"[COMPRESSED] \" + compressed.strip()\n        \n        # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ª—è –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        compressed_msg = Message(\n            id=msg.id,\n            thread_id=msg.thread_id,\n            role=msg.role,\n            content=compressed_content,\n            tokens=TokenCounter().count(compressed_content),\n            metadata=msg.metadata,\n            created_at=msg.created_at\n        )\n        \n        return compressed_msg\n        \n    except Exception as e:\n        logger.warning(f\"Compression failed for {msg.role} message: {e}\")\n        return msg\n\n\ndef prune_irrelevant_context(history: List[Message], current_query: str) -> List[Message]:\n    \"\"\"\n    –£–¥–∞–ª—è–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–π–ª–æ–≤,\n    —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –≤ —Ç–µ–∫—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ.\n\n    Args:\n        history: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.\n        current_query: –¢–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n    Returns:\n        –ò—Å—Ç–æ—Ä–∏—è —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º–∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.\n    \"\"\"\n    # –£–ª—É—á—à–µ–Ω–Ω—ã–π regex –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤\n    file_pattern = r'[\\w/\\-]+\\.(?:py|js|ts|sql|json|md|txt|html|css|go|java|cpp|c|rs|rb)|\\b(?:src|lib|app|tests|config)/[\\w/.-]+'\n    \n    # –ò–∑–≤–ª–µ–∫–∞–µ–º —É–ø–æ–º—è–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞\n    mentioned_files = set(re.findall(file_pattern, current_query))\n    \n    # –ï—Å–ª–∏ —Ñ–∞–π–ª—ã –Ω–µ —É–ø–æ–º—è–Ω—É—Ç—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π\n    if not mentioned_files:\n        return history\n    \n    pruned_history = []\n    \n    for msg in history:\n        if msg.role != 'tool':\n            pruned_history.append(msg)\n        else:\n            # –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è\n            content_files = set(re.findall(file_pattern, msg.content))\n            \n            # –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:\n            # –ï—Å–ª–∏ content_files –ù–ï –ø—É—Å—Ç –ò –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å mentioned_files –ü–£–°–¢–û ‚Üí —ç—Ç–æ –º—É—Å–æ—Ä\n            if content_files and not content_files.intersection(mentioned_files):\n                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è\n                first_file = next(iter(content_files), \"unknown\")\n                pruned_content = f\"[PRUNED: {first_file} –±—ã–ª –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ]\"\n                pruned_msg = Message(\n                    id=msg.id,\n                    thread_id=msg.thread_id,\n                    role=msg.role,\n                    content=pruned_content,\n                    tokens=TokenCounter().count(pruned_content),\n                    metadata=msg.metadata,\n                    created_at=msg.created_at\n                )\n                pruned_history.append(pruned_msg)\n            else:\n                # –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ –Ω—É–∂–Ω—ã ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\n                pruned_history.append(msg)\n    \n    return pruned_history",
        "context": null
      }
    ],
    "explanation": "–≠—Ç–æ—Ç –∫–æ–¥ –≤–Ω–æ—Å–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –º–æ–¥—É–ª—å —Å–∂–∞—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤:\n\n1. **–£–¥–∞–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤** - —É–±—Ä–∞–Ω—ã —Å—Ç—Ä–æ–∫–∏ 188-190, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞–ª–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞, —Ç–∞–∫ –∫–∞–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è.\n\n2. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ —Å–∂–∞—Ç–∏—è** - –ø–æ—Ä–æ–≥ —É–≤–µ–ª–∏—á–µ–Ω —Å 8000 –¥–æ 30000 —Ç–æ–∫–µ–Ω–æ–≤. –≠—Ç–æ –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ –∏—Å—Ç–æ—Ä–∏–∏.\n\n3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫–æ–¥–æ–º** - –≤ —Ñ—É–Ω–∫—Ü–∏—é `compress_history_if_needed` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è assistant-—Å–æ–æ–±—â–µ–Ω–∏–π: –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–ª–æ–∫–∏ –∫–æ–¥–∞, –æ–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ —Å–∂–∞—Ç–∏—è —Å –∑–∞–ø–∏—Å—å—é –≤ –ª–æ–≥. –≠—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–∞–∂–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∫–æ–¥–∞ –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º–∏.\n\n4. **–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ `prune_irrelevant_context`**:\n   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–Ω—ã–π regex-–ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –±–æ–ª—å—à–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –∏ –ø—É—Ç–µ–π\n   - –õ–æ–≥–∏–∫–∞ –æ–±—Ä–µ–∑–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∞: —Ç–µ–ø–µ—Ä—å —É–¥–∞–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ñ–∞–π–ª—ã, –ù–ï —É–ø–æ–º—è–Ω—É—Ç—ã–µ –≤ —Ç–µ–∫—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ\n   - –°–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ —Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è\n   - –§–æ—Ä–º–∞—Ç –æ–±—Ä–µ–∑–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å—Ç–∞–ª –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º - —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª\n\n**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**\n- –ú–æ–¥—É–ª—å —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫\n- –°–∂–∞—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ 30000 —Ç–æ–∫–µ–Ω–æ–≤\n- –ë–ª–æ–∫–∏ –∫–æ–¥–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç —Å–∂–∞—Ç–∏—è\n- –û–±—Ä–µ–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞–ª–∞ –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π - —É–¥–∞–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤\n\n**–í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ:** –§—É–Ω–∫—Ü–∏–∏ `compress_history_if_needed` –∏ `prune_irrelevant_context` —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω—ã –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–∑–≤–Ω–µ –º–æ–¥—É–ª—è, –∞ –Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ. –≠—Ç–æ –¥–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –≤—Ä–µ–º–µ–Ω–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.",
    "frontend_json": {
      "success": true,
      "code_blocks": [
        {
          "code": "\"\"\"\n–ú–æ–¥—É–ª—å –¥–ª—è —Å–∂–∞—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ –ª–µ—Ç—É –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î (—Ä–µ–∂–∏–º Recompute).\n–†–µ–∞–ª–∏–∑—É–µ—Ç –¥–≤–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:\n1. –¢–æ–∫–µ–Ω-–±–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ: —Å–∂–∏–º–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é LLM,\n   —Å–æ—Ö—Ä–∞–Ω—è—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–ª–æ–∫–∏ –∫–æ–¥–∞.\n2. –û–±—Ä–µ–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: —É–¥–∞–ª—è–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.\n\"\"\"\n\nimport asyncio\nimport logging\nimport re\nfrom typing import List, Optional\nfrom dataclasses import dataclass\nfrom app.llm.prompt_templates import format_compression_prompt\nfrom app.history.storage import Message\nfrom app.utils.token_counter import TokenCounter\nfrom app.llm.api_client import call_llm\nfrom config.settings import cfg\n\nlogger = logging.getLogger(__name__)\n\n\ndef _contains_code_block(content: str) -> bool:\n    \"\"\"\n    –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –±–ª–æ–∫–∏ –∫–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown (—Ç—Ä–æ–π–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏).\n    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç chr(96)*3 –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–∞–≤—ã—á–µ–∫ –≤ –∫–æ–¥–µ.\n\n    Args:\n        content: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.\n\n    Returns:\n        True, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –±–ª–æ–∫–∏ –∫–æ–¥–∞, –∏–Ω–∞—á–µ False.\n    \"\"\"\n    triple_backticks = chr(96) * 3\n    return triple_backticks in content\n\n\nasync def compress_history_if_needed(history: List[Message], threshold: int = 30000) -> List[Message]:\n    \"\"\"\n    –°–∂–∏–º–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.\n    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏, –∞ —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–∂–∏–º–∞–µ—Ç —Å –ø–æ–º–æ—â—å—é LLM.\n\n    Args:\n        history: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.\n        threshold: –ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Å–∂–∞—Ç–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30000).\n\n    Returns:\n        –°–∂–∞—Ç—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ —Å–∂–∞—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.\n    \"\"\"\n    token_counter = TokenCounter()\n    total_tokens = sum(token_counter.count(msg.content) for msg in history)\n    \n    if total_tokens <= threshold:\n        return history\n    \n    compressed_history = []\n    keep_last_n = 3\n    \n    # –†–∞–∑–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —á–∞—Å—Ç—å –¥–ª—è —Å–∂–∞—Ç–∏—è –∏ —á–∞—Å—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è\n    to_compress = history[:-keep_last_n] if len(history) > keep_last_n else []\n    keep_intact = history[-keep_last_n:] if len(history) > keep_last_n else history\n    \n    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Å–∂–∞—Ç–∏—è\n    for msg in to_compress:\n        if msg.role == 'user':\n            compressed_history.append(msg)\n        elif msg.role == 'assistant':\n            if _contains_code_block(msg.content):\n                logger.debug(f\"Skipping compression for assistant message {msg.id} due to code block\")\n                compressed_history.append(msg)\n            else:\n                compressed_msg = await _compress_message(msg, \"reasoning\")\n                compressed_history.append(compressed_msg)\n        elif msg.role == 'tool':\n            compressed_msg = await _compress_message(msg, \"tool_result\")\n            compressed_history.append(compressed_msg)\n        else:\n            compressed_history.append(msg)\n    \n    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n    compressed_history.extend(keep_intact)\n    \n    # –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∂–∞—Ç–∏—è\n    compressed_tokens = sum(token_counter.count(msg.content) for msg in compressed_history)\n    logger.info(f\"History compressed: {total_tokens} ‚Üí {compressed_tokens} tokens \"\n                f\"({compressed_tokens/total_tokens*100:.1f}% of original)\")\n    \n    return compressed_history\n\n\nasync def _compress_message(msg: Message, content_type: str) -> Message:\n    \"\"\"\n    –°–∂–∏–º–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é LLM, –∏—Å–ø–æ–ª—å–∑—É—è —à–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤.\n    –ù–µ —Å–∂–∏–º–∞–µ—Ç —É–∂–µ —Å–∂–∞—Ç—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–ª–æ–∫–∞–º–∏ –∫–æ–¥–∞.\n\n    Args:\n        msg: –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Å–∂–∞—Ç–∏—è.\n        content_type: –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ('reasoning' –∏–ª–∏ 'tool_result').\n\n    Returns:\n        –°–∂–∞—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.\n    \"\"\"\n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–∂–∞—Ç–æ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ\n    if msg.content.startswith(\"[COMPRESSED]\"):\n        return msg\n    \n    # –ù–µ —Å–∂–∏–º–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–ª–æ–∫–∞–º–∏ –∫–æ–¥–∞\n    if _contains_code_block(msg.content):\n        return msg\n    \n    try:\n        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–∂–∞—Ç–∏—è\n        prompt = format_compression_prompt(msg.content, content_type)\n        \n        # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª—å –¥–ª—è —Å–∂–∞—Ç–∏—è\n        model = cfg.AGENT_MODELS.get(\"history_compressor\", \"deepseek/deepseek-chat\")\n        \n        # –í—ã–∑—ã–≤–∞–µ–º LLM –¥–ª—è —Å–∂–∞—Ç–∏—è\n        compressed = await call_llm(\n            model=model,\n            messages=[{\"role\": \"user\", \"content\": prompt}],\n            temperature=0.0,\n            max_tokens=2000\n        )\n        \n        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–∂–∞—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n        compressed_content = \"[COMPRESSED] \" + compressed.strip()\n        \n        # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ª—è –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        compressed_msg = Message(\n            id=msg.id,\n            thread_id=msg.thread_id,\n            role=msg.role,\n            content=compressed_content,\n            tokens=TokenCounter().count(compressed_content),\n            metadata=msg.metadata,\n            created_at=msg.created_at\n        )\n        \n        return compressed_msg\n        \n    except Exception as e:\n        logger.warning(f\"Compression failed for {msg.role} message: {e}\")\n        return msg\n\n\ndef prune_irrelevant_context(history: List[Message], current_query: str) -> List[Message]:\n    \"\"\"\n    –£–¥–∞–ª—è–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–π–ª–æ–≤,\n    —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –≤ —Ç–µ–∫—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ.\n\n    Args:\n        history: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.\n        current_query: –¢–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n    Returns:\n        –ò—Å—Ç–æ—Ä–∏—è —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º–∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.\n    \"\"\"\n    # –£–ª—É—á—à–µ–Ω–Ω—ã–π regex –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤\n    file_pattern = r'[\\w/\\-]+\\.(?:py|js|ts|sql|json|md|txt|html|css|go|java|cpp|c|rs|rb)|\\b(?:src|lib|app|tests|config)/[\\w/.-]+'\n    \n    # –ò–∑–≤–ª–µ–∫–∞–µ–º —É–ø–æ–º—è–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞\n    mentioned_files = set(re.findall(file_pattern, current_query))\n    \n    # –ï—Å–ª–∏ —Ñ–∞–π–ª—ã –Ω–µ —É–ø–æ–º—è–Ω—É—Ç—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π\n    if not mentioned_files:\n        return history\n    \n    pruned_history = []\n    \n    for msg in history:\n        if msg.role != 'tool':\n            pruned_history.append(msg)\n        else:\n            # –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è\n            content_files = set(re.findall(file_pattern, msg.content))\n            \n            # –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:\n            # –ï—Å–ª–∏ content_files –ù–ï –ø—É—Å—Ç –ò –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å mentioned_files –ü–£–°–¢–û ‚Üí —ç—Ç–æ –º—É—Å–æ—Ä\n            if content_files and not content_files.intersection(mentioned_files):\n                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è\n                first_file = next(iter(content_files), \"unknown\")\n                pruned_content = f\"[PRUNED: {first_file} –±—ã–ª –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ]\"\n                pruned_msg = Message(\n                    id=msg.id,\n                    thread_id=msg.thread_id,\n                    role=msg.role,\n                    content=pruned_content,\n                    tokens=TokenCounter().count(pruned_content),\n                    metadata=msg.metadata,\n                    created_at=msg.created_at\n                )\n                pruned_history.append(pruned_msg)\n            else:\n                # –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ –Ω—É–∂–Ω—ã ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\n                pruned_history.append(msg)\n    \n    return pruned_history",
          "filepath": "app/history/compressor.py",
          "language": "python",
          "context": null
        }
      ],
      "combined_code": "\n\n# ==================================================# filepath: app/history/compressor.py\n\n\"\"\"\n–ú–æ–¥—É–ª—å –¥–ª—è —Å–∂–∞—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ –ª–µ—Ç—É –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î (—Ä–µ–∂–∏–º Recompute).\n–†–µ–∞–ª–∏–∑—É–µ—Ç –¥–≤–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:\n1. –¢–æ–∫–µ–Ω-–±–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ: —Å–∂–∏–º–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é LLM,\n   —Å–æ—Ö—Ä–∞–Ω—è—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–ª–æ–∫–∏ –∫–æ–¥–∞.\n2. –û–±—Ä–µ–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: —É–¥–∞–ª—è–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.\n\"\"\"\n\nimport asyncio\nimport logging\nimport re\nfrom typing import List, Optional\nfrom dataclasses import dataclass\nfrom app.llm.prompt_templates import format_compression_prompt\nfrom app.history.storage import Message\nfrom app.utils.token_counter import TokenCounter\nfrom app.llm.api_client import call_llm\nfrom config.settings import cfg\n\nlogger = logging.getLogger(__name__)\n\n\ndef _contains_code_block(content: str) -> bool:\n    \"\"\"\n    –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –±–ª–æ–∫–∏ –∫–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown (—Ç—Ä–æ–π–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏).\n    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç chr(96)*3 –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–∞–≤—ã—á–µ–∫ –≤ –∫–æ–¥–µ.\n\n    Args:\n        content: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.\n\n    Returns:\n        True, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –±–ª–æ–∫–∏ –∫–æ–¥–∞, –∏–Ω–∞—á–µ False.\n    \"\"\"\n    triple_backticks = chr(96) * 3\n    return triple_backticks in content\n\n\nasync def compress_history_if_needed(history: List[Message], threshold: int = 30000) -> List[Message]:\n    \"\"\"\n    –°–∂–∏–º–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.\n    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏, –∞ —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–∂–∏–º–∞–µ—Ç —Å –ø–æ–º–æ—â—å—é LLM.\n\n    Args:\n        history: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.\n        threshold: –ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Å–∂–∞—Ç–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30000).\n\n    Returns:\n        –°–∂–∞—Ç—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ —Å–∂–∞—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.\n    \"\"\"\n    token_counter = TokenCounter()\n    total_tokens = sum(token_counter.count(msg.content) for msg in history)\n    \n    if total_tokens <= threshold:\n        return history\n    \n    compressed_history = []\n    keep_last_n = 3\n    \n    # –†–∞–∑–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —á–∞—Å—Ç—å –¥–ª—è —Å–∂–∞—Ç–∏—è –∏ —á–∞—Å—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è\n    to_compress = history[:-keep_last_n] if len(history) > keep_last_n else []\n    keep_intact = history[-keep_last_n:] if len(history) > keep_last_n else history\n    \n    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Å–∂–∞—Ç–∏—è\n    for msg in to_compress:\n        if msg.role == 'user':\n            compressed_history.append(msg)\n        elif msg.role == 'assistant':\n            if _contains_code_block(msg.content):\n                logger.debug(f\"Skipping compression for assistant message {msg.id} due to code block\")\n                compressed_history.append(msg)\n            else:\n                compressed_msg = await _compress_message(msg, \"reasoning\")\n                compressed_history.append(compressed_msg)\n        elif msg.role == 'tool':\n            compressed_msg = await _compress_message(msg, \"tool_result\")\n            compressed_history.append(compressed_msg)\n        else:\n            compressed_history.append(msg)\n    \n    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n    compressed_history.extend(keep_intact)\n    \n    # –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∂–∞—Ç–∏—è\n    compressed_tokens = sum(token_counter.count(msg.content) for msg in compressed_history)\n    logger.info(f\"History compressed: {total_tokens} ‚Üí {compressed_tokens} tokens \"\n                f\"({compressed_tokens/total_tokens*100:.1f}% of original)\")\n    \n    return compressed_history\n\n\nasync def _compress_message(msg: Message, content_type: str) -> Message:\n    \"\"\"\n    –°–∂–∏–º–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é LLM, –∏—Å–ø–æ–ª—å–∑—É—è —à–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤.\n    –ù–µ —Å–∂–∏–º–∞–µ—Ç —É–∂–µ —Å–∂–∞—Ç—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–ª–æ–∫–∞–º–∏ –∫–æ–¥–∞.\n\n    Args:\n        msg: –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Å–∂–∞—Ç–∏—è.\n        content_type: –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ('reasoning' –∏–ª–∏ 'tool_result').\n\n    Returns:\n        –°–∂–∞—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.\n    \"\"\"\n    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–∂–∞—Ç–æ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ\n    if msg.content.startswith(\"[COMPRESSED]\"):\n        return msg\n    \n    # –ù–µ —Å–∂–∏–º–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–ª–æ–∫–∞–º–∏ –∫–æ–¥–∞\n    if _contains_code_block(msg.content):\n        return msg\n    \n    try:\n        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–∂–∞—Ç–∏—è\n        prompt = format_compression_prompt(msg.content, content_type)\n        \n        # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª—å –¥–ª—è —Å–∂–∞—Ç–∏—è\n        model = cfg.AGENT_MODELS.get(\"history_compressor\", \"deepseek/deepseek-chat\")\n        \n        # –í—ã–∑—ã–≤–∞–µ–º LLM –¥–ª—è —Å–∂–∞—Ç–∏—è\n        compressed = await call_llm(\n            model=model,\n            messages=[{\"role\": \"user\", \"content\": prompt}],\n            temperature=0.0,\n            max_tokens=2000\n        )\n        \n        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–∂–∞—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n        compressed_content = \"[COMPRESSED] \" + compressed.strip()\n        \n        # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ª—è –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\n        compressed_msg = Message(\n            id=msg.id,\n            thread_id=msg.thread_id,\n            role=msg.role,\n            content=compressed_content,\n            tokens=TokenCounter().count(compressed_content),\n            metadata=msg.metadata,\n            created_at=msg.created_at\n        )\n        \n        return compressed_msg\n        \n    except Exception as e:\n        logger.warning(f\"Compression failed for {msg.role} message: {e}\")\n        return msg\n\n\ndef prune_irrelevant_context(history: List[Message], current_query: str) -> List[Message]:\n    \"\"\"\n    –£–¥–∞–ª—è–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–π–ª–æ–≤,\n    —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –≤ —Ç–µ–∫—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ.\n\n    Args:\n        history: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.\n        current_query: –¢–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n    Returns:\n        –ò—Å—Ç–æ—Ä–∏—è —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º–∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.\n    \"\"\"\n    # –£–ª—É—á—à–µ–Ω–Ω—ã–π regex –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤\n    file_pattern = r'[\\w/\\-]+\\.(?:py|js|ts|sql|json|md|txt|html|css|go|java|cpp|c|rs|rb)|\\b(?:src|lib|app|tests|config)/[\\w/.-]+'\n    \n    # –ò–∑–≤–ª–µ–∫–∞–µ–º —É–ø–æ–º—è–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞\n    mentioned_files = set(re.findall(file_pattern, current_query))\n    \n    # –ï—Å–ª–∏ —Ñ–∞–π–ª—ã –Ω–µ —É–ø–æ–º—è–Ω—É—Ç—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π\n    if not mentioned_files:\n        return history\n    \n    pruned_history = []\n    \n    for msg in history:\n        if msg.role != 'tool':\n            pruned_history.append(msg)\n        else:\n            # –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è\n            content_files = set(re.findall(file_pattern, msg.content))\n            \n            # –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:\n            # –ï—Å–ª–∏ content_files –ù–ï –ø—É—Å—Ç –ò –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å mentioned_files –ü–£–°–¢–û ‚Üí —ç—Ç–æ –º—É—Å–æ—Ä\n            if content_files and not content_files.intersection(mentioned_files):\n                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è\n                first_file = next(iter(content_files), \"unknown\")\n                pruned_content = f\"[PRUNED: {first_file} –±—ã–ª –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ]\"\n                pruned_msg = Message(\n                    id=msg.id,\n                    thread_id=msg.thread_id,\n                    role=msg.role,\n                    content=pruned_content,\n                    tokens=TokenCounter().count(pruned_content),\n                    metadata=msg.metadata,\n                    created_at=msg.created_at\n                )\n                pruned_history.append(pruned_msg)\n            else:\n                # –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ –Ω—É–∂–Ω—ã ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\n                pruned_history.append(msg)\n    \n    return pruned_history",
      "explanation": "–≠—Ç–æ—Ç –∫–æ–¥ –≤–Ω–æ—Å–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –º–æ–¥—É–ª—å —Å–∂–∞—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤:\n\n1. **–£–¥–∞–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤** - —É–±—Ä–∞–Ω—ã —Å—Ç—Ä–æ–∫–∏ 188-190, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞–ª–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞, —Ç–∞–∫ –∫–∞–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è.\n\n2. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ —Å–∂–∞—Ç–∏—è** - –ø–æ—Ä–æ–≥ —É–≤–µ–ª–∏—á–µ–Ω —Å 8000 –¥–æ 30000 —Ç–æ–∫–µ–Ω–æ–≤. –≠—Ç–æ –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ –∏—Å—Ç–æ—Ä–∏–∏.\n\n3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫–æ–¥–æ–º** - –≤ —Ñ—É–Ω–∫—Ü–∏—é `compress_history_if_needed` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è assistant-—Å–æ–æ–±—â–µ–Ω–∏–π: –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–ª–æ–∫–∏ –∫–æ–¥–∞, –æ–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ —Å–∂–∞—Ç–∏—è —Å –∑–∞–ø–∏—Å—å—é –≤ –ª–æ–≥. –≠—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–∞–∂–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∫–æ–¥–∞ –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º–∏.\n\n4. **–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ `prune_irrelevant_context`**:\n   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–Ω—ã–π regex-–ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –±–æ–ª—å—à–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –∏ –ø—É—Ç–µ–π\n   - –õ–æ–≥–∏–∫–∞ –æ–±—Ä–µ–∑–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∞: —Ç–µ–ø–µ—Ä—å —É–¥–∞–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ñ–∞–π–ª—ã, –ù–ï —É–ø–æ–º—è–Ω—É—Ç—ã–µ –≤ —Ç–µ–∫—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ\n   - –°–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ —Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è\n   - –§–æ—Ä–º–∞—Ç –æ–±—Ä–µ–∑–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å—Ç–∞–ª –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º - —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª\n\n**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**\n- –ú–æ–¥—É–ª—å —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫\n- –°–∂–∞—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ 30000 —Ç–æ–∫–µ–Ω–æ–≤\n- –ë–ª–æ–∫–∏ –∫–æ–¥–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç —Å–∂–∞—Ç–∏—è\n- –û–±—Ä–µ–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞–ª–∞ –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π - —É–¥–∞–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤\n\n**–í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ:** –§—É–Ω–∫—Ü–∏–∏ `compress_history_if_needed` –∏ `prune_irrelevant_context` —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω—ã –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–∑–≤–Ω–µ –º–æ–¥—É–ª—è, –∞ –Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ. –≠—Ç–æ –¥–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –≤—Ä–µ–º–µ–Ω–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.",
      "error": null,
      "model_used": "deepseek-chat",
      "tokens_used": 0
    }
  }
}