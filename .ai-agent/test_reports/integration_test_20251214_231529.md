# ü§ñ AI Code Agent - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –¢–µ—Å—Ç

**–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 14.12.2025 23:15:29
**–ü—Ä–æ–µ–∫—Ç:** `C:\Users\Admin\AI_Assistant_Pro`
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 186.81 —Å–µ–∫.

---

## üìù –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

> –¢—ã –Ω–∞—á–∞–ª –ø–∏—Å–∞—Ç—å —Ñ–∞–π–ª, –Ω–æ –æ–Ω –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ –∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≥–ª–∞–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏.–¢–∞–∫–∂–µ —Ç—ã –ø—ã—Ç–∞–µ—à—å—Å—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–º–ø—Ç—ã (`format_compression_prompt`).**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é:**1.  **–î–æ–ø–∏—à–∏ —Ñ–∞–π–ª –¥–æ –∫–æ–Ω—Ü–∞.** –í –Ω–µ–º –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –¥–≤–µ –≥–ª–∞–≤–Ω—ã–µ –ø—É–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:    *   `compress_history_if_needed(history: List[Message], threshold: int) -> List[Message]`    *   `prune_irrelevant_context(history: List[Message], current_query: str) -> List[Message]`2.  **–ü—Ä–æ–º–ø—Ç—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–¥–∞:**    *   –ù–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π –ø—Ä–æ–º–ø—Ç—ã. –û–ø—Ä–µ–¥–µ–ª–∏ –∏—Ö –∫–∞–∫ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä—è–º–æ –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ:        *   `TOOL_COMPRESSION_PROMPT`: "–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫... —Å–æ–∂–º–∏ –¥–æ 20%... –æ—Å—Ç–∞–≤—å —Ñ–∞–∫—Ç—ã..."        *   `ASSISTANT_COMPRESSION_PROMPT`: "–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫... —Å–æ–∂–º–∏ –¥–æ 30%... —Å–æ—Ö—Ä–∞–Ω–∏ –ª–æ–≥–∏–∫—É..."3.  **–õ–æ–≥–∏–∫–∞ `compress_history_if_needed`:**    *   –ü–æ—Å—á–∏—Ç–∞–π `total_tokens` —á–µ—Ä–µ–∑ `token_counter`.    *   –ï—Å–ª–∏ < `threshold`, –≤–µ—Ä–Ω–∏ `history` (–∫–æ–ø–∏—é).    *   –ï—Å–ª–∏ –±–æ–ª—å—à–µ:        *   –ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è (`history[-3:]`) –æ—Å—Ç–∞–≤—å –∫–∞–∫ –µ—Å—Ç—å.        *   –û—Å—Ç–∞–ª—å–Ω—ã–µ (`history[:-3]`) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π:            *   `user` ‚Üí –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å.            *   `assistant` —Å –±–ª–æ–∫–∞–º–∏ –∫–æ–¥–∞ (```            *   `assistant` –±–µ–∑ –∫–æ–¥–∞ ‚Üí –≤—ã–∑–æ–≤–∏ LLM —Å `ASSISTANT_COMPRESSION_PROMPT`.            *   `tool` ‚Üí –≤—ã–∑–æ–≤–∏ LLM —Å `TOOL_COMPRESSION_PROMPT`.    *   –ï—Å–ª–∏ –≤—ã–∑–æ–≤ LLM —É–ø–∞–ª (try/except), –≤–µ—Ä–Ω–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.    *   –î–æ–±–∞–≤—å –ø—Ä–µ—Ñ–∏–∫—Å `[COMPRESSED]` –∫ —Å–∂–∞—Ç–æ–º—É —Ç–µ–∫—Å—Ç—É.4.  **–õ–æ–≥–∏–∫–∞ `prune_irrelevant_context`:**    *   –ò—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ—é —Ñ—É–Ω–∫—Ü–∏—é `_extract_file_paths` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ `current_query`.    *   –ï—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤, –≤–µ—Ä–Ω–∏ –∏—Å—Ç–æ—Ä–∏—é –∫–∞–∫ –µ—Å—Ç—å (–Ω–µ–ª—å–∑—è –ø—Ä—É–Ω–∏—Ç—å, –µ—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç).    *   –ï—Å–ª–∏ —Ñ–∞–π–ª—ã –µ—Å—Ç—å:        *   –ü—Ä–æ—Ö–æ–¥–∏ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º `role='tool'`.        *   –ï—Å–ª–∏ –≤ tool output —É–ø–æ–º–∏–Ω–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ –∑–∞–ø—Ä–æ—Å–µ ‚Üí –∑–∞–º–µ–Ω–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ `[PRUNED: ...]`.5.  **–ò–º–ø–æ—Ä—Ç—ã:**    *   –£–±–µ–¥–∏—Å—å, —á—Ç–æ –∏–º–ø–æ—Ä—Ç `call_llm` (–∏–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞) –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–ª—É—à–∫—É –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `app.llm.api_client`.**–í—ã–¥–∞–π –ü–û–õ–ù–´–ô –∫–æ–¥ —Ñ–∞–π–ª–∞ `compressor.py` –±–µ–∑ –æ–±—Ä—ã–≤–æ–≤.**

---

## üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏

- **Orchestrator:** Claude Opus 4.5 (RouterAI)
- **Code Generator:** deepseek-chat

---

## üîç –ê–Ω–∞–ª–∏–∑ –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞

–§–∞–π–ª `app/history/compressor.py` –∏–º–µ–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–û–±—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ** - —Ñ—É–Ω–∫—Ü–∏—è `_contains_code_block` –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (—Å—Ç—Ä–æ–∫–∞ 63 –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ `if '`)
2. **–ò–º–ø–æ—Ä—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–º–ø—Ç–∞** - —Ö–æ—Ç—è `format_compression_prompt` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `prompt_templates.py`, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç—Ä–µ–±—É–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ
3. **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≥–ª–∞–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** - `compress_history_if_needed` –∏ `prune_irrelevant_context` –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
4. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - `call_llm` —è–≤–ª—è–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π, –ø–æ—ç—Ç–æ–º—É —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∂–∞—Ç–∏—è —Ç–æ–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏

–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ñ–∞–π–ª —Å:
- –õ–æ–∫–∞–ª—å–Ω—ã–º–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ `TOOL_COMPRESSION_PROMPT` –∏ `ASSISTANT_COMPRESSION_PROMPT`
- –ó–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π `_contains_code_block`
- –†–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π `compress_history_if_needed` —Å –ª–æ–≥–∏–∫–æ–π:
  - –ü–æ–¥—Å—á—ë—Ç —Ç–æ–∫–µ–Ω–æ–≤
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 —Å–æ–æ–±—â–µ–Ω–∏–π
  - –°–∂–∞—Ç–∏–µ `assistant` (–±–µ–∑ –∫–æ–¥–∞) –∏ `tool` —á–µ—Ä–µ–∑ LLM
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
  - –ü—Ä–µ—Ñ–∏–∫—Å `[COMPRESSED]`
- –†–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π `prune_irrelevant_context` —Å –ª–æ–≥–∏–∫–æ–π:
  - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
  - –ó–∞–º–µ–Ω–∞ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö tool outputs –Ω–∞ `[PRUNED: ...]`

---

## üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Code Generator

**Task:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ñ–∞–π–ª `compressor.py` —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π —Å–∂–∞—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏

**File:** `app/history/compressor.py`

**Location:** –ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞

**Changes:**

1. **–ò–º–ø–æ—Ä—Ç—ã (—Å—Ç—Ä–æ–∫–∏ 1-20):**
   - –£–¥–∞–ª–∏—Ç—å –∏–º–ø–æ—Ä—Ç `from app.llm.prompt_templates import format_compression_prompt`
   - –û—Å—Ç–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã: `re`, `logging`, `asyncio` (–¥–æ–±–∞–≤–∏—Ç—å), `List`, `Dict`, `Any`, `Optional`, `Set` –∏–∑ `typing`, `dataclasses.replace`
   - –û—Å—Ç–∞–≤–∏—Ç—å: `from app.history.storage import Message`
   - –û—Å—Ç–∞–≤–∏—Ç—å: `from app.utils.token_counter import TokenCounter`
   - –û—Å—Ç–∞–≤–∏—Ç—å: `from app.llm.api_client import call_llm`
   - –û—Å—Ç–∞–≤–∏—Ç—å: `from config.settings import cfg`
   - –°–æ–∑–¥–∞—Ç—å `logger = logging.getLogger(__name__)` –∏ `token_counter = TokenCounter()`

2. **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–æ–º–ø—Ç–æ–≤ (–ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–æ–≤, –ø–µ—Ä–µ–¥ —Ñ—É–Ω–∫—Ü–∏—è–º–∏):**
   ```python
   TOOL_COMPRESSION_PROMPT = """–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫. –°–æ–∂–º–∏ —Å–ª–µ–¥—É—é—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–æ ~20% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.

   –°–û–•–†–ê–ù–ò:
   - –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏ –∏ –≤—ã–≤–æ–¥—ã
   - –í–∞–∂–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∫–æ–¥–∞ (—Å–æ–∫—Ä–∞—Ç–∏ –¥–æ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫)
   - –ò–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –∏ –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫
   - –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å)

   –£–î–ê–õ–ò:
   - –ü–æ–ª–Ω—ã–µ –ª–∏—Å—Ç–∏–Ω–≥–∏ –∫–æ–¥–∞ (–æ—Å—Ç–∞–≤—å —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –≤—ã–¥–µ—Ä–∂–∫–∏)
   - –ú–Ω–æ–≥–æ—Å–ª–æ–≤–Ω—ã–π/–∏–∑–±—ã—Ç–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
   - –î—É–±–ª–∏—Ä—É—é—â—É—é—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
   - –õ–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

   –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:
   {content}

   –°–∂–∞—Ç–∞—è –≤–µ—Ä—Å–∏—è:"""

   ASSISTANT_COMPRESSION_PROMPT = """–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫. –°–æ–∂–º–∏ —Å–ª–µ–¥—É—é—â–µ–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ/–∞–Ω–∞–ª–∏–∑ –¥–æ ~30% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.

   –°–û–•–†–ê–ù–ò:
   - –ì–ª–∞–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã –∏ —Ä–µ—à–µ–Ω–∏—è
   - –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ
   - –í–∞–∂–Ω—ã–µ –æ–≥–æ–≤–æ—Ä–∫–∏ –∏–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
   - –õ–æ–≥–∏–∫—É –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π

   –£–î–ê–õ–ò:
   - –ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π
   - –ú–Ω–æ–≥–æ—Å–ª–æ–≤–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
   - –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –æ—Ç–≤–µ—Ä–≥–Ω—É—Ç—ã
   - –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

   –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ:
   {content}

   –°–∂–∞—Ç–∞—è –≤–µ—Ä—Å–∏—è:"""
   ```

3. **–§—É–Ω–∫—Ü–∏—è `_extract_file_paths` (–æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, —Å—Ç—Ä–æ–∫–∏ ~23-49):**
   - –§—É–Ω–∫—Ü–∏—è —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

4. **–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `_contains_code_block` (—Å—Ç—Ä–æ–∫–∏ ~52-70):**
   ```python
   def _contains_code_block(text: str) -> bool:
       """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –±–ª–æ–∫–∏ –∫–æ–¥–∞."""
       if not text:
           return False
       # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–ª–æ–∫–∏ –∫–æ–¥–∞ –≤ markdown (—Ç—Ä–æ–π–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏)
       if '```' in text:
           return True
       # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ XML-–æ–±—ë—Ä–Ω—É—Ç—ã–π –∫–æ–¥
       if '<code>' in text or '<CODE>' in text:
           return True
       return False
   ```

5. **–î–æ–±–∞–≤–∏—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `_compress_with_llm` (–ø–æ—Å–ª–µ `_contains_code_block`):**
   ```python
   async def _compress_with_llm(content: str, prompt_template: str) -> Optional[str]:
       """
       –°–∂–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç —Å –ø–æ–º–æ—â—å—é LLM.
       
       Args:
           content: –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å–∂–∞—Ç–∏—è
           prompt_template: –®–∞–±–ª–æ–Ω –ø—Ä–æ–º–ø—Ç–∞ (TOOL_COMPRESSION_PROMPT –∏–ª–∏ ASSISTANT_COMPRESSION_PROMPT)
       
       Returns:
           –°–∂–∞—Ç—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
       """
       try:
           prompt = prompt_template.format(content=content)
           messages = [{"role": "user", "content": prompt}]
           
           # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±—ã—Å—Ç—Ä—É—é –º–æ–¥–µ–ª—å –¥–ª—è —Å–∂–∞—Ç–∏—è (Gemini 2.0 Flash –∏–ª–∏ –∞–Ω–∞–ª–æ–≥)
           model = getattr(cfg, 'COMPRESSION_MODEL', 'google/gemini-2.0-flash-001')
           
           result = await call_llm(
               model=model,
               messages=messages,
               temperature=0.0,
               max_tokens=2000
           )
           return result
       except Exception as e:
           logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∂–∞—Ç–∏–∏ —á–µ—Ä–µ–∑ LLM: {e}")
           return None
   ```

6. **–î–æ–±–∞–≤–∏—Ç—å –≥–ª–∞–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `compress_history_if_needed` (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è):**
   ```python
   async def compress_history_if_needed(history: List[Message], threshold: int) -> List[Message]:
       """
       –°–∂–∏–º–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞, –µ—Å–ª–∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Ä–æ–≥.
       
       Args:
           history: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
           threshold: –ü–æ—Ä–æ–≥ —Ç–æ–∫–µ–Ω–æ–≤, –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–∂–∞—Ç–∏–µ
       
       Returns:
           –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (–≤–æ–∑–º–æ–∂–Ω–æ —Å–∂–∞—Ç—ã—Ö)
       """
       if not history:
           return []
       
       # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤
       total_tokens = sum(
           msg.tokens if msg.tokens > 0 else token_counter.count(msg.content)
           for msg in history
       )
       
       # –ï—Å–ª–∏ –º–µ–Ω—å—à–µ –ø–æ—Ä–æ–≥–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–ø–∏—é –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
       if total_tokens < threshold:
           return [replace(msg) for msg in history]
       
       logger.info(f"–°–∂–∞—Ç–∏–µ –∏—Å—Ç–æ—Ä–∏–∏: {total_tokens} —Ç–æ–∫–µ–Ω–æ–≤ > {threshold} –ø–æ—Ä–æ–≥")
       
       # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
       if len(history) <= 3:
           return [replace(msg) for msg in history]
       
       messages_to_compress = history[:-3]
       recent_messages = history[-3:]
       
       compressed_messages = []
       
       for msg in messages_to_compress:
           # user —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
           if msg.role == 'user':
               compressed_messages.append(replace(msg))
               continue
           
           # assistant —Å –±–ª–æ–∫–∞–º–∏ –∫–æ–¥–∞ - –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
           if msg.role == 'assistant' and _contains_code_block(msg.content):
               compressed_messages.append(replace(msg))
               continue
           
           # assistant –±–µ–∑ –∫–æ–¥–∞ - —Å–∂–∏–º–∞–µ–º
           if msg.role == 'assistant':
               compressed_content = await _compress_with_llm(msg.content, ASSISTANT_COMPRESSION_PROMPT)
               if compressed_content:
                   new_content = f"[COMPRESSED] {compressed_content}"
                   new_tokens = token_counter.count(new_content)
                   compressed_messages.append(replace(msg, content=new_content, tokens=new_tokens))
               else:
                   # –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
                   compressed_messages.append(replace(msg))
               continue
           
           # tool - —Å–∂–∏–º–∞–µ–º
           if msg.role == 'tool':
               compressed_content = await _compress_with_llm(msg.content, TOOL_COMPRESSION_PROMPT)
               if compressed_content:
                   new_content = f"[COMPRESSED] {compressed_content}"
                   new_tokens = token_counter.count(new_content)
                   compressed_messages.append(replace(msg, content=new_content, tokens=new_tokens))
               else:
                   # –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
                   compressed_messages.append(replace(msg))
               continue
           
           # –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–æ–ª–∏ (system –∏ –¥—Ä.) - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
           compressed_messages.append(replace(msg))
       
       # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
       for msg in recent_messages:
           compressed_messages.append(replace(msg))
       
       return compressed_messages
   ```

7. **–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `prune_irrelevant_context`:**
   ```python
   def prune_irrelevant_context(history: List[Message], current_query: str) -> List[Message]:
       """
       –£–¥–∞–ª—è–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
       
       Args:
           history: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
           current_query: –¢–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
       
       Returns:
           –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–º–∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ tool outputs
       """
       if not history:
           return []
       
       # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∞–π–ª—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
       query_files = _extract_file_paths(current_query)
       
       # –ï—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤ - –Ω–µ –º–æ–∂–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
       if not query_files:
           return [replace(msg) for msg in history]
       
       logger.debug(f"–§–∞–π–ª—ã –≤ –∑–∞–ø—Ä–æ—Å–µ: {query_files}")
       
       pruned_messages = []
       
       for msg in history:
           # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ tool —Å–æ–æ–±—â–µ–Ω–∏—è
           if msg.role != 'tool':
               pruned_messages.append(replace(msg))
               continue
           
           # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∞–π–ª—ã –∏–∑ tool output
           tool_files = _extract_file_paths(msg.content)
           
           # –ï—Å–ª–∏ –≤ tool output –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤ - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
           if not tool_files:
               pruned_messages.append(replace(msg))
               continue
           
           # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å —Ñ–∞–π–ª–∞–º–∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
           relevant_files = query_files & tool_files
           
           if relevant_files:
               # –ï—Å—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã - –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
               pruned_messages.append(replace(msg))
           else:
               # –ù–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ - –æ–±—Ä–µ–∑–∞–µ–º
               # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
               mentioned_files = list(tool_files)[:3]
               files_str = ", ".join(mentioned_files)
               if len(tool_files) > 3:
                   files_str += f" –∏ –µ—â—ë {len(tool_files) - 3}"
               
               pruned_content = f"[PRUNED: tool output –æ —Ñ–∞–π–ª–∞—Ö {files_str}, –Ω–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ç–µ–∫—É—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É]"
               new_tokens = token_counter.count(pruned_content)
               pruned_messages.append(replace(msg, content=pruned_content, tokens=new_tokens))
               logger.debug(f"–û–±—Ä–µ–∑–∞–Ω–æ tool —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ñ–∞–π–ª–∞—Ö: {tool_files}")
       
       return pruned_messages
   ```

**Why:** –§–∞–π–ª –±—ã–ª –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω –∏ —Å–æ–¥–µ—Ä–∂–∞–ª –∏–º–ø–æ—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ —Å–∂–∞—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –≤ –¥–∏–∞–ª–æ–≥–∞—Ö —Å LLM.

---

## üíª –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥

### –ë–ª–æ–∫ 1

**–§–∞–π–ª:** `app/history/compressor.py`

```python
"""
–ú–æ–¥—É–ª—å –¥–ª—è —Å–∂–∞—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ –ª–µ—Ç—É –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î (—Ä–µ–∂–∏–º Recompute).
–†–µ–∞–ª–∏–∑—É–µ—Ç –¥–≤–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:
1. –¢–æ–∫–µ–Ω-–±–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ: —Å–∂–∏–º–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –±—ã—Å—Ç—Ä–æ–π LLM (Gemini 2.0 Flash),
   —Å–æ—Ö—Ä–∞–Ω—è—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–ª–æ–∫–∏ –∫–æ–¥–∞.
2. –û–±—Ä–µ–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: —É–¥–∞–ª—è–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
"""

import re
import logging
import asyncio
from typing import List, Dict, Any, Optional, Set
from dataclasses import replace
from app.history.storage import Message
from app.utils.token_counter import TokenCounter
from app.llm.api_client import call_llm
from config.settings import cfg

logger = logging.getLogger(__name__)
token_counter = TokenCounter()

TOOL_COMPRESSION_PROMPT = """–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫. –°–æ–∂–º–∏ —Å–ª–µ–¥—É—é—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–æ ~20% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.

–°–û–•–†–ê–ù–ò:
- –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏ –∏ –≤—ã–≤–æ–¥—ã
- –í–∞–∂–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∫–æ–¥–∞ (—Å–æ–∫—Ä–∞—Ç–∏ –¥–æ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫)
- –ò–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –∏ –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫
- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å)

–£–î–ê–õ–ò:
- –ü–æ–ª–Ω—ã–µ –ª–∏—Å—Ç–∏–Ω–≥–∏ –∫–æ–¥–∞ (–æ—Å—Ç–∞–≤—å —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –≤—ã–¥–µ—Ä–∂–∫–∏)
- –ú–Ω–æ–≥–æ—Å–ª–æ–≤–Ω—ã–π/–∏–∑–±—ã—Ç–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
- –î—É–±–ª–∏—Ä—É—é—â—É—é—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –õ–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:
{content}

–°–∂–∞—Ç–∞—è –≤–µ—Ä—Å–∏—è:"""

ASSISTANT_COMPRESSION_PROMPT = """–¢—ã ‚Äî AI-–∞–Ω–∞–ª–∏—Ç–∏–∫. –°–æ–∂–º–∏ —Å–ª–µ–¥—É—é—â–µ–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ/–∞–Ω–∞–ª–∏–∑ –¥–æ ~30% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.

–°–û–•–†–ê–ù–ò:
- –ì–ª–∞–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã –∏ —Ä–µ—à–µ–Ω–∏—è
- –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ
- –í–∞–∂–Ω—ã–µ –æ–≥–æ–≤–æ—Ä–∫–∏ –∏–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- –õ–æ–≥–∏–∫—É –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π

–£–î–ê–õ–ò:
- –ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π
- –ú–Ω–æ–≥–æ—Å–ª–æ–≤–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –æ—Ç–≤–µ—Ä–≥–Ω—É—Ç—ã
- –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ:
{content}

–°–∂–∞—Ç–∞—è –≤–µ—Ä—Å–∏—è:"""


def _extract_file_paths(text: str) -> Set[str]:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ–º–æ—â—å—é —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π.

    Args:
        text: –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.

    Returns:
        –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—Å—Ç–µ.
    """
    if not text:
        return set()

    # –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º
    pattern = r'(?:^|[\s"\'\(])([a-zA-Z0-9_\-./\\]+\.[a-zA-Z0-9]+)(?:[\s"\'\)]|$)'
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–±—â–∏—Ö –ø—É—Ç–µ–π
    common_path_pattern = r'(?:^|[\s"\'\(])((?:app|src|config|tests|scripts)/[a-zA-Z0-9_\-./\\]+)(?:[\s"\'\)]|$)'

    file_paths = set()
    # –ò—â–µ–º —Ñ–∞–π–ª—ã —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏
    for match in re.finditer(pattern, text):
        file_paths.add(match.group(1))
    # –ò—â–µ–º –æ–±—â–∏–µ –ø—É—Ç–∏
    for match in re.finditer(common_path_pattern, text):
        file_paths.add(match.group(1))

    return file_paths


def _contains_code_block(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –±–ª–æ–∫–∏ –∫–æ–¥–∞."""
    if not text:
        return False
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–ª–æ–∫–∏ –∫–æ–¥–∞ –≤ markdown (—Ç—Ä–æ–π–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏)
    if '
```

### –ë–ª–æ–∫ 2

**–§–∞–π–ª:** `app/history/compressor.py`

```python
### Explanation

–≠—Ç–æ—Ç –∫–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç –º–æ–¥—É–ª—å `compressor.py`, —Ä–µ–∞–ª–∏–∑—É—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å–∂–∞—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –≤ LLM-–¥–∏–∞–ª–æ–≥–∞—Ö. –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

**1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–º–ø–æ—Ä—Ç–æ–≤:**
- –£–¥–∞–ª—ë–Ω –∏–º–ø–æ—Ä—Ç `format_compression_prompt` –∏–∑ `app.llm.prompt_templates`
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `asyncio` –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏, —Ç–æ–∫–µ–Ω–∞–º–∏ –∏ LLM API

**2. –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–≤–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–æ–º–ø—Ç–æ–≤ (`TOOL_COMPRESSION_PROMPT` –∏ `ASSISTANT_COMPRESSION_PROMPT`) –ø—Ä—è–º–æ –≤ —Ñ–∞–π–ª
- –ö–∞–∂–¥—ã–π –ø—Ä–æ–º–ø—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Å–∂–∞—Ç–∏—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ vs —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)

**3. –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `_contains_code_block` —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ —á–µ—Ä–µ–∑ –º–∞—Ä–∫–µ—Ä—ã
```

---

## üìñ –ü–æ—è—Å–Ω–µ–Ω–∏—è –∫ –∫–æ–¥—É

–≠—Ç–æ—Ç –∫–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç –º–æ–¥—É–ª—å `compressor.py`, —Ä–µ–∞–ª–∏–∑—É—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å–∂–∞—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –≤ LLM-–¥–∏–∞–ª–æ–≥–∞—Ö. –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

**1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–º–ø–æ—Ä—Ç–æ–≤:**
- –£–¥–∞–ª—ë–Ω –∏–º–ø–æ—Ä—Ç `format_compression_prompt` –∏–∑ `app.llm.prompt_templates`
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `asyncio` –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏, —Ç–æ–∫–µ–Ω–∞–º–∏ –∏ LLM API

**2. –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–≤–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–æ–º–ø—Ç–æ–≤ (`TOOL_COMPRESSION_PROMPT` –∏ `ASSISTANT_COMPRESSION_PROMPT`) –ø—Ä—è–º–æ –≤ —Ñ–∞–π–ª
- –ö–∞–∂–¥—ã–π –ø—Ä–æ–º–ø—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Å–∂–∞—Ç–∏—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ vs —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)

**3. –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `_contains_code_block` —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ —á–µ—Ä–µ–∑ –º–∞—Ä–∫–µ—Ä—ã ` –Ω–µ —Å–∂–∏–º–∞–µ—Ç—Å—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏

---

## üõ†Ô∏è –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

1. ‚úÖ **read_file**
   - –ê—Ä–≥—É–º–µ–Ω—Ç—ã: `file_path=app/history/compressor.py`

2. ‚úÖ **read_code_chunk**
   - –ê—Ä–≥—É–º–µ–Ω—Ç—ã: `file_path=app/llm/prompt_templates.py, chunk_name=format_compression_prompt`

3. ‚úÖ **read_code_chunk**
   - –ê—Ä–≥—É–º–µ–Ω—Ç—ã: `file_path=app/history/storage.py, chunk_name=Message`

4. ‚úÖ **read_code_chunk**
   - –ê—Ä–≥—É–º–µ–Ω—Ç—ã: `file_path=app/llm/prompt_templates.py, chunk_name=_build_history_compressor_tool_result_prompt`

5. ‚úÖ **read_code_chunk**
   - –ê—Ä–≥—É–º–µ–Ω—Ç—ã: `file_path=app/llm/prompt_templates.py, chunk_name=_build_history_compressor_reasoning_prompt`

6. ‚úÖ **read_code_chunk**
   - –ê—Ä–≥—É–º–µ–Ω—Ç—ã: `file_path=app/llm/api_client.py, chunk_name=call_llm`

7. ‚úÖ **read_file**
   - –ê—Ä–≥—É–º–µ–Ω—Ç—ã: `file_path=app/history/storage.py, include_line_numbers=True`

---

*–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: 2025-12-14T23:15:29.199356*