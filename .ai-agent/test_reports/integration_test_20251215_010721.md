# ü§ñ AI Code Agent - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –¢–µ—Å—Ç

**–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 15.12.2025 01:07:21
**–ü—Ä–æ–µ–∫—Ç:** `C:\Users\Admin\AI_Assistant_Pro`
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 177.82 —Å–µ–∫.

---

## üìù –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

> –£ –º–µ–Ω—è –≤—ã—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∞, –º–æ–∂–µ—à—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ –µ—â–µ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫, –ø–æ—Å–ª–µ —á–µ–≥–æ –ø–µ—Ä–µ–ø–∏—à–∏ –µ–≥–æ –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è—è, –∫—Ä–æ–º–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ File "c:\Users\Admin\AI_Assistant_Pro\scripts\test_history_manager.py", line 10, in <module>    from app.history.manager import HistoryManagerModuleNotFoundError: No module named 'app'

---

## üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏

- **Orchestrator:** Claude Sonnet 4.5 (RouterAI)
- **Code Generator:** deepseek-chat

---

## üîç –ê–Ω–∞–ª–∏–∑ –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞

**–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∞ `ModuleNotFoundError: No module named 'app'` –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ Python –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –º–æ–¥—É–ª—å `app` –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–∞ –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `scripts/`. –°–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã (`from app.history.manager import ...`), –Ω–æ –∫–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (`c:\Users\Admin\AI_Assistant_Pro\`) –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `sys.path`.

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ sys.path** (—Å—Ç—Ä–æ–∫–∏ 9-14) - –≥–ª–∞–≤–Ω–∞—è –æ—à–∏–±–∫–∞
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ test_imports()** (—Å—Ç—Ä–æ–∫–∏ 62-93) - —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã, —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ—Ç, —á—Ç–æ –∏–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω. –≠—Ç–æ –±–µ—Å–ø–æ–ª–µ–∑–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞.
3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ Config** (—Å—Ç—Ä–æ–∫–∞ 106) - `Config()` —Å–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä, –Ω–æ –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `.get()` –∫–∞–∫ –¥–ª—è —Å–ª–æ–≤–∞—Ä—è, —á—Ç–æ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∞—Å—Å–∞ Config
4. **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ —Å Message** (—Å—Ç—Ä–æ–∫–∏ 296-302) - —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ Message –±–µ–∑ –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π (thread_id, tokens –∏ —Ç.–¥. –∏–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞)
5. **–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤** (—Å—Ç—Ä–æ–∫–∏ 225, 245) - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏–º–∏—Ç–∏–≤–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ `len(msg.content.split()) * 1.3`, —Ö–æ—Ç—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω TokenCounter

---

## üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Code Generator

**Task:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª—è 'app' –∏ –¥—Ä—É–≥–∏–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Å–∫—Ä–∏–ø—Ç–µ

**File:** `scripts/test_history_manager.py`

**Location:** –†–∞–∑–ª–∏—á–Ω—ã–µ –º–µ—Å—Ç–∞ –≤ —Ñ–∞–π–ª–µ (—Å–º. –¥–µ—Ç–∞–ª–∏ –Ω–∏–∂–µ)

**Changes:**

1. **–î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ sys.path** (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 4, –ø–µ—Ä–µ–¥ —Å—Ç—Ä–æ–∫–æ–π 9):
   - –î–æ–±–∞–≤–∏—Ç—å –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ `from pathlib import Path`
   - –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: `# Add project root to sys.path for imports`
   - –î–æ–±–∞–≤–∏—Ç—å –∫–æ–¥:
     ```python
     project_root = Path(__file__).resolve().parent.parent
     if str(project_root) not in sys.path:
         sys.path.insert(0, str(project_root))
     ```
   - –î–æ–±–∞–≤–∏—Ç—å –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞

2. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é test_imports()** (—Å—Ç—Ä–æ–∫–∏ 77-86):
   - –ó–∞–º–µ–Ω–∏—Ç—å –≤–µ—Å—å –±–ª–æ–∫ try-except –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∏–º–ø–æ—Ä—Ç–∞:
     ```python
     try:
         __import__(module_path)
         logger.info(f"‚úì Import successful: {module_path} -> {import_names}")
     ```
   - –û—Å—Ç–∞–ª—å–Ω–æ–µ –æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

3. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ Config** (—Å—Ç—Ä–æ–∫–∞ 106):
   - –ó–∞–º–µ–Ω–∏—Ç—å `Config().get("compressor_model", "gpt-3.5-turbo")` –Ω–∞:
     ```python
     model = getattr(Config, 'COMPRESSOR_MODEL', 'deepseek-chat')
     ```

4. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤** (—Å—Ç—Ä–æ–∫–∏ 225-226):
   - –ó–∞–º–µ–Ω–∏—Ç—å –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π —Ä–∞—Å—á–µ—Ç –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TokenCounter:
     ```python
     token_counter = TokenCounter()
     initial_tokens = sum(token_counter.count(msg.content) for msg in messages)
     ```

5. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ (–≤—Ç–æ—Ä–æ–π —Å–ª—É—á–∞–π)** (—Å—Ç—Ä–æ–∫–∏ 245-246):
   - –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞:
     ```python
     before_tokens = sum(token_counter.count(msg.content) for msg in messages)
     ```

6. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ Message –≤ test_prune_context()** (—Å—Ç—Ä–æ–∫–∏ 296-302):
   - –ó–∞–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ Message –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–ª–æ–≤–∞—Ä–µ–π (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º):
     ```python
     messages = [
         Message(id="1", thread_id="test", role="user", content="Show me the auth service code", tokens=0),
         Message(id="2", thread_id="test", role="tool", content="File: app/services/auth.py\nCode: def authenticate(): ...", tokens=0),
         Message(id="3", thread_id="test", role="tool", content="File: app/utils/logger.py\nCode: def log(): ...", tokens=0),
         Message(id="4", thread_id="test", role="tool", content="File: app/models/user.py\nCode: class User: ...", tokens=0),
         Message(id="5", thread_id="test", role="assistant", content="Here's the auth service code...", tokens=0),
         Message(id="6", thread_id="test", role="user", content="Now modify only app/services/auth.py", tokens=0),
     ]
     ```

7. **–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–∫–∏ –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ tests/** (—Å—Ç—Ä–æ–∫–∞ 154):
   - –ü–µ—Ä–µ–¥ —Å—Ç—Ä–æ–∫–æ–π 154 –¥–æ–±–∞–≤–∏—Ç—å:
     ```python
     # Ensure tests directory exists
     db_path = Path("tests/test_history.db")
     db_path.parent.mkdir(parents=True, exist_ok=True)
     ```
   - –£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É 154 (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ `db_path = Path("tests/test_history.db")`)

**Why:** 
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Ññ1 —Ä–µ—à–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É - Python —Å–º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –º–æ–¥—É–ª—å `app`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Ññ2-6 —É—Å—Ç—Ä–∞–Ω—è—é—Ç –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–≤–µ–¥—É—Ç –∫ —Å–±–æ—è–º –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Ññ7 –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ tests/
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –ª–æ–≥–∏–∫—É –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–¥–∞, —Ç–æ–ª—å–∫–æ –∏—Å–ø—Ä–∞–≤–ª—è—é—Ç –æ—à–∏–±–∫–∏

---

## üíª –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥

**–§–∞–π–ª:** `scripts/test_history_manager.py`

```python
import asyncio
import logging
import sys
from pathlib import Path
from datetime import datetime
from typing import List, Dict, Any, Tuple
import traceback

# Add project root to sys.path for imports
project_root = Path(__file__).resolve().parent.parent
if str(project_root) not in sys.path:
    sys.path.insert(0, str(project_root))

# Project-specific imports
from app.history.manager import HistoryManager
from app.history.storage import HistoryStorage, Thread, Message
from app.history.compressor import compress_history_if_needed, prune_irrelevant_context
from app.utils.token_counter import TokenCounter
from config.settings import Config


def setup_logging() -> None:
    """Configure colored logging with timestamps."""
    # Custom log level for success
    SUCCESS_LEVEL_NUM = 25
    logging.addLevelName(SUCCESS_LEVEL_NUM, "SUCCESS")

    def success(self, message, *args, **kwargs):
        if self.isEnabledFor(SUCCESS_LEVEL_NUM):
            self._log(SUCCESS_LEVEL_NUM, message, args, **kwargs)

    logging.Logger.success = success

    # Color codes
    COLORS = {
        'INFO': '\033[96m',      # Cyan
        'WARNING': '\033[93m',   # Yellow
        'ERROR': '\033[91m',     # Red
        'SUCCESS': '\033[92m',   # Green
        'RESET': '\033[0m',      # Reset
    }

    class ColoredFormatter(logging.Formatter):
        def format(self, record):
            levelname = record.levelname
            if levelname in COLORS:
                levelname_color = f"{COLORS[levelname]}{levelname}{COLORS['RESET']}"
                record.levelname = levelname_color
            return super().format(record)

    # Configure handler
    handler = logging.StreamHandler()
    formatter = ColoredFormatter(
        '[%(asctime)s] [%(levelname)s] %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    handler.setFormatter(formatter)

    # Configure root logger
    logger = logging.getLogger()
    logger.setLevel(logging.DEBUG)
    logger.addHandler(handler)

    logging.info("Logging configured successfully")


def test_imports() -> bool:
    """Test all required imports."""
    logger = logging.getLogger(__name__)
    logger.info("Testing imports...")

    imports_to_test = [
        ("app.history.manager", "HistoryManager"),
        ("app.history.storage", "HistoryStorage, Thread, Message"),
        ("app.history.compressor", "compress_history_if_needed, prune_irrelevant_context"),
        ("app.utils.token_counter", "TokenCounter"),
        ("config.settings", "Config"),
    ]

    all_successful = True

    for module_path, import_names in imports_to_test:
        try:
            __import__(module_path)
            logger.info(f"‚úì Import successful: {module_path} -> {import_names}")
        except ImportError as e:
            logger.error(f"‚úó Import failed for {module_path}: {e}")
            all_successful = False
        except Exception as e:
            logger.error(f"‚úó Unexpected error importing {module_path}: {e}")
            all_successful = False

    if all_successful:
        logger.success("All imports successful")
    else:
        logger.error("Some imports failed")

    return all_successful


async def test_api_connection() -> bool:
    """Test API connection for history compression."""
    logger = logging.getLogger(__name__)
    logger.info("Testing API connection for history compression...")

    try:
        # Import here to avoid circular dependencies
        from app.llm.api_client import call_llm

        # Get model from config
        model = getattr(Config, 'COMPRESSOR_MODEL', 'deepseek-chat')

        # Prepare test message
        messages = [{"role": "user", "content": "test"}]

        logger.debug(f"Calling LLM API with model: {model}")

        # Call API
        response = await call_llm(
            model=model,
            messages=messages,
            temperature=0.1,
            max_tokens=50
        )

        # Extract response content
        if hasattr(response, 'content'):
            content = response.content
        elif isinstance(response, dict) and 'content' in response:
            content = response['content']
        else:
            content = str(response)

        preview = content[:50] + "..." if len(content) > 50 else content
        logger.success(f"API connection successful. Response preview: {preview}")
        return True

    except ImportError as e:
        logger.error(f"Failed to import api_client: {e}")
        return False
    except ConnectionError as e:
        logger.error(f"Connection error: {e}")
        return False
    except TimeoutError as e:
        logger.error(f"Timeout error: {e}")
        return False
    except Exception as e:
        logger.exception(f"Unexpected error during API test: {e}")
        return False


def test_create_history() -> Tuple[str, HistoryManager]:
    """Create a new conversation thread with test messages."""
    logger = logging.getLogger(__name__)
    logger.info("Creating new conversation thread...")

    try:
        # Ensure tests directory exists
        db_path = Path("tests/test_history.db")
        db_path.parent.mkdir(parents=True, exist_ok=True)

        # Initialize HistoryManager with test database
        manager = HistoryManager(db_path=str(db_path))

        # Create new thread
        thread = manager.create_thread(
            user_id="test_user",
            project_path="test_project",
            project_name="Test Project"
        )

        thread_id = thread.id
        logger.info(f"Thread created with ID: {thread_id}")

        # Assert thread_id is not None
        assert thread_id is not None, "Thread ID should not be None"
        logger.debug(f"Assertion passed: thread_id = {thread_id}")

        # Add test messages
        test_messages = [
            {"role": "user", "content": "Hello, can you help me with my project?"},
            {"role": "assistant", "content": "Of course! I'd be happy to help. What's your project about?"},
            {"role": "user", "content": "It's a web application using FastAPI and React."},
            {"role": "assistant", "content": "Great choice! FastAPI is excellent for backend APIs."},
            {"role": "user", "content": "I need help with authentication setup."},
        ]

        for i, msg_data in enumerate(test_messages, 1):
            message = manager.add_message(
                thread_id=thread_id,
                role=msg_data["role"],
                content=msg_data["content"]
            )
            logger.info(f"Added message {i}/{len(test_messages)}: {message.id}")

        # Verify message count
        messages = manager.get_session_history(thread_id)
        assert len(messages) == len(test_messages), \
            f"Expected {len(test_messages)} messages, got {len(messages)}"
        logger.debug(f"Assertion passed: {len(messages)} messages added")

        # Get thread statistics
        stats = manager.get_thread_statistics(thread_id)
        logger.info(f"Thread statistics: {stats.get('total_messages', 0)} messages, "
                   f"{stats.get('total_tokens', 0)} tokens")

        logger.success("Thread creation test completed successfully")
        return thread_id, manager

    except FileNotFoundError as e:
        logger.error(f"Database file not found: {e}")
        raise
    except ValueError as e:
        logger.error(f"Invalid value: {e}")
        raise
    except Exception as e:
        logger.exception(f"Unexpected error in thread creation: {e}")
        raise


async def test_history_compression(manager: HistoryManager, thread_id: str) -> Dict[str, Any]:
    """Test dynamic history compression."""
    logger = logging.getLogger(__name__)
    logger.info("Testing dynamic history compression...")

    try:
        # Get initial messages
        messages = manager.get_session_history(thread_id)
        initial_count = len(messages)

        # Calculate initial tokens (simplified)
        token_counter = TokenCounter()
        initial_tokens = sum(token_counter.count(msg.content) for msg in messages)

        logger.info(f"Initial state: {initial_count} messages, ~{int(initial_tokens)} tokens")

        # Add more messages to trigger compression
        logger.info("Adding messages to trigger compression threshold...")
        long_content = "This is a long message " * 20  # ~200 tokens

        for i in range(1, 11):
            role = "user" if i % 2 == 1 else "assistant"
            manager.add_message(
                thread_id=thread_id,
                role=role,
                content=f"{long_content} - Message {i}"
            )
            logger.debug(f"Added long message {i}/10")

        # Get updated messages
        messages = manager.get_session_history(thread_id)
        before_count = len(messages)
        before_tokens = sum(token_counter.count(msg.content) for msg in messages)

        logger.info(f"Before compression: {before_count} messages, ~{int(before_tokens)} tokens")

        # Apply compression
        compression_result = await compress_history_if_needed(
            messages=messages,
            token_threshold=2000
        )

        after_count = len(compression_result.get("compressed_messages", []))
        after_tokens = compression_result.get("total_tokens_after", 0)
        pruned_count = compression_result.get("pruned_count", 0)

        logger.info(f"After compression: {after_count} messages, ~{int(after_tokens)} tokens")
        logger.info(f"Pruned {pruned_count} messages")

        # Verify compression occurred
        compression_happened = (after_tokens < before_tokens) or (after_count < before_count)
        assert compression_happened, "Compression should reduce tokens or message count"

        if compression_happened:
            logger.success("Compression test passed successfully")
        else:
            logger.warning("No compression happened - might be below threshold")

        return {
            "before_count": before_count,
            "before_tokens": before_tokens,
            "after_count": after_count,
            "after_tokens": after_tokens,
            "pruned_count": pruned_count,
            "compression_happened": compression_happened
        }

    except AssertionError as e:
        logger.error(f"Assertion failed: {e}")
        raise
    except Exception as e:
        logger.exception(f"Unexpected error in compression test: {e}")
        raise


def test_prune_context() -> Dict[str, Any]:
    """Test context pruning for irrelevant tool results."""
    logger = logging.getLogger(__name__)
    logger.info("Testing context pruning for irrelevant tool results...")

    try:
        # Create test messages with tool results
        messages = [
            Message(id="1", thread_id="test", role="user", content="Show me the auth service code", tokens=0),
            Message(id="2", thread_id="test", role="tool", content="File: app/services/auth.py\nCode: def authenticate(): ...", tokens=0),
            Message(id="3", thread_id="test", role="tool", content="File: app/utils/logger.py\nCode: def log(): ...", tokens=0),
            Message(id="4", thread_id="test", role="tool", content="File: app/models/user.py\nCode: class User: ...", tokens=0),
            Message(id="5", thread_id="test", role="assistant", content="Here's the auth service code...", tokens=0),
            Message(id="6", thread_id="test", role="user", content="Now modify only app/services/auth.py", tokens=0),
        ]

        original_count = len(messages)
        logger.info(f"Original messages: {original_count}")

        # User query mentioning specific file
        user_query = "Modify the authenticate function in app/services/auth.py"

        # Apply pruning
        pruned_messages = prune_irrelevant_context(
            messages=messages,
            user_query=user_query
        )

        pruned_count = len(pruned_messages)
        logger.info(f"After pruning: {pruned_count} messages")
        logger.info(f"Removed {original_count - pruned_count} irrelevant messages")

        # Verify irrelevant tool results were removed
        tool_messages_before = [m for m in messages if m.role == "tool"]
        tool_messages_after = [m for m in pruned_messages if m.role == "tool"]

        # Check that only auth.py tool result remains
        auth_tools = [m for m in tool_messages_after if "auth.py" in m.content]
        other_tools = [m for m in tool_messages_after if "auth.py" not in m.content]

        assert len(other_tools) == 0, "Irrelevant tool results should be removed"
        assert len(auth_tools) > 0, "Relevant tool results should remain"

        logger.success("Context pruning test passed successfully")

        return {
            "original_count": original_count,
            "pruned_count": pruned_count,
            "removed_count": original_count - pruned_count,
            "files_mentioned": ["app/services/auth.py"]
        }

    except AssertionError as e:
        logger.error(f"Assertion failed: {e}")
        raise
    except Exception as e:
        logger.exception(f"Unexpected error in pruning test: {e}")
        raise


def cleanup_test_database() -> bool:
    """Clean up test database file."""
    logger = logging.getLogger(__name__)
    logger.info("Cleaning up test database...")

    try:
        db_path = Path("tests/test_history.db")
        if db_path.exists():
            db_path.unlink()
            logger.success(f"Removed test database: {db_path}")
            return True
        else:
            logger.info("Test database does not exist, nothing to clean up")
            return True
    except Exception as e:
        logger.error(f"Failed to clean up test database: {e}")
        return False


async def main() -> int:
    """Main test runner."""
    print("\n" + "=" * 40)
    print("=== HISTORY MANAGEMENT TEST SUITE ===")
    print("=" * 40 + "\n")

    # Setup logging
    setup_logging()
    logger = logging.getLogger(__name__)

    # Test results tracker
    test_results = {}

    try:
        # Test 1: Imports
        logger.info("Starting test: Imports")
        test_results["imports"] = test_imports()

        if not test_results["imports"]:
            logger.error("Import test failed. Skipping further tests.")
            return 1

        # Test 2: API Connection
        logger.info("Starting test: API Connection")
        test_results["api_connection"] = await test_api_connection()

        if not test_results["api_connection"]:
            logger.warning("API connection test failed. Some tests may be limited.")

        # Test 3: Create History
        logger.info("Starting test: Create History")
        try:
            thread_id, manager = test_create_history()
            test_results["create_history"] = True
        except Exception:
            test_results["create_history"] = False
            thread_id, manager = None, None

        # Test 4: History Compression (if history created successfully)
        if test_results.get("create_history") and thread_id and manager:
            logger.info("Starting test: History Compression")
            try:
                compression_stats = await test_history_compression(manager, thread_id)
                test_results["history_compression"] = compression_stats.get("compression_happened", False)
            except Exception:
                test_results["history_compression"] = False
        else:
            logger.warning("Skipping compression test - history creation failed")
            test_results["history_compression"] = False

        # Test 5: Prune Context
        logger.info("Starting test: Prune Context")
        try:
            prune_stats = test_prune_context()
            test_results["prune_context"] = prune_stats.get("removed_count", 0) > 0
        except Exception:
            test_results["prune_context"] = False

        # Cleanup
        logger.info("Starting cleanup")
        test_results["cleanup"] = cleanup_test_database()

    except KeyboardInterrupt:
        logger.error("Test suite interrupted by user")
        return 1
    except Exception as e:
        logger.exception(f"Unexpected error in main test runner: {e}")
        return 1

    # Print summary
    print("\n" + "=" * 40)
    print("=== TEST RESULTS ===")
    print("=" * 40)

    passed = sum(1 for result in test_results.values() if result is True)
    total = sum(1 for result in test_results.values() if isinstance(result, bool))

    print(f"\nSummary: {passed}/{total} tests passed")

    for test_name, result in test_results.items():
        status = "‚úì PASS" if result else "‚úó FAIL"
        color = '\033[92m' if result else '\033[91m'
        reset = '\033[0m'
        print(f"  {color}{status}{reset}: {test_name}")

    print("\n" + "=" * 40)

    # Return exit code
    if passed == total:
        logger.success("All tests passed!")
        return 0
    else:
        logger.error(f"{total - passed} test(s) failed")
        return 1


if __name__ == "__main__":
    exit_code = asyncio.run(main())
    sys.exit(exit_code)
```

---

## üìñ –ü–æ—è—Å–Ω–µ–Ω–∏—è –∫ –∫–æ–¥—É

–≠—Ç–æ—Ç –∫–æ–¥ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Å–∫—Ä–∏–ø—Ç–µ `test_history_manager.py`, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –±—ã –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Å–±–æ—è–º –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤. –í–æ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–Ω–µ—Å–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π:

1. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ sys.path** (—Å—Ç—Ä–æ–∫–∏ 9-13

---

## üõ†Ô∏è –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

1. ‚úÖ **read_file**
   - –ê—Ä–≥—É–º–µ–Ω—Ç—ã: `file_path=scripts/test_history_manager.py`

---

*–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: 2025-12-15T01:07:21.604531*