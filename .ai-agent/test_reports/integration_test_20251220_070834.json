{
  "metadata": {
    "timestamp": "2025-12-20T07:08:34.115871",
    "project_dir": "C:\\Users\\Admin\\AI_Assistant_Pro",
    "user_query": "У меня возникает проблема при пользовании General Chat, а именно выходит ошибка. Проанализируй и напиши код решения   File \"c:\\Users\\Admin\\AI_Assistant_Pro\\scripts\\test_general_chat.py\", line 128, in main    result: GeneralChatResult = await orchestrator.orchestrate_general(                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^  File \"c:\\Users\\Admin\\AI_Assistant_Pro\\app\\agents\\orchestrator.py\", line 858, in orchestrate_general    messages = [{\"role\": \"system\", \"content\": prompts[\"system\"]}]                                              ~~~~~~~^^^^^^^^^^TypeError: string indices must be integers, not 'str'",
    "duration_seconds": 177.34303784370422,
    "models_used": {
      "orchestrator": "Claude Sonnet 4.5 (RouterAI)",
      "code_generator": "deepseek-chat"
    }
  },
  "orchestrator": {
    "analysis": "**ROOT CAUSE:** Функция `format_orchestrator_prompt_general` в файле `app/llm/prompt_templates.py` (строки 2111-2197) возвращает **строку** (`return \"\\n\".join(prompt_parts)`), но должна возвращать **словарь** с ключами `'system'` и `'user'`, как указано в её сигнатуре (`-> Dict[str, str]`).\n\nПри этом код в `app/agents/orchestrator.py` (строка 858) ожидает словарь:\n```python\nmessages = [{\"role\": \"system\", \"content\": prompts[\"system\"]}]\nmessages.extend(history)\nmessages.append({\"role\": \"user\", \"content\": prompts[\"user\"]})\n```\n\nНо получает строку, поэтому попытка обращения `prompts[\"system\"]` вызывает `TypeError: string indices must be integers, not 'str'`.\n\n**Все остальные функции форматирования** (`format_orchestrator_prompt`, `format_orchestrator_prompt_ask`, `format_orchestrator_prompt_new_project`, `format_prefilter_prompt`, `format_code_generator_prompt`) возвращают словари вида `{\"system\": str, \"user\": str}`.\n\n**Решение:** Исправить `format_orchestrator_prompt_general`, чтобы она возвращала словарь с двумя ключами:\n- `\"system\"` — системный промпт (текущее содержимое функции)\n- `\"user\"` — пользовательский промпт (должен содержать запрос пользователя и прикреплённые файлы)",
    "instruction": "**SCOPE:** A (Single file, single function modification)\n\n**Task:** Исправить функцию `format_orchestrator_prompt_general`, чтобы она возвращала словарь вместо строки, приведя её в соответствие с остальными функциями форматирования промптов.\n\n**File:** `app/llm/prompt_templates.py`\n\n**Target Location:**\n- Function name: `format_orchestrator_prompt_general`\n- Line numbers: 2111-2197\n- Identifying pattern: `def format_orchestrator_prompt_general(`\n\n**Current Code (строки 2111-2197):**\n```python\ndef format_orchestrator_prompt_general(\n    user_query: str,\n    user_files: List[Dict[str, str]] = None,\n    is_legal_mode: bool = False,\n    remaining_web_searches: int = MAX_WEB_SEARCH_CALLS,\n) -> Dict[str, str]:\n    \"\"\"\n    Строит системный промпт для режима General Chat.\n    Args:\n        is_legal_mode: Если True, добавляет юридическую специфику и строгость.\n    \"\"\"\n    prompt_parts = []\n    \n    # [... весь код построения системного промпта ...]\n    \n    return \"\\n\".join(prompt_parts)  # ❌ ОШИБКА: возвращает строку, а не словарь\n```\n\n**Required Changes:**\n\n1. **Разделить логику** на построение `system` промпта (текущая логика) и `user` промпта (новая логика)\n2. **Добавить построение user промпта**, который должен включать:\n   - Запрос пользователя (`user_query`)\n   - Содержимое прикреплённых файлов (`user_files`), если они есть\n3. **Вернуть словарь** вида `{\"system\": system_prompt, \"user\": user_prompt}`\n\n**New/Modified Code:**\n\n```python\ndef format_orchestrator_prompt_general(\n    user_query: str,\n    user_files: List[Dict[str, str]] = None,\n    is_legal_mode: bool = False,\n    remaining_web_searches: int = MAX_WEB_SEARCH_CALLS,\n) -> Dict[str, str]:\n    \"\"\"\n    Строит системный и пользовательский промпты для режима General Chat.\n    \n    Args:\n        user_query: Запрос пользователя\n        user_files: Список файлов с ключами 'filename' и 'content'\n        is_legal_mode: Если True, добавляет юридическую специфику и строгость.\n        remaining_web_searches: Количество оставшихся веб-поисков\n        \n    Returns:\n        Dict с ключами \"system\" и \"user\"\n    \"\"\"\n    prompt_parts = []\n    \n    # --- ROLE DEFINITION ---\n    if is_legal_mode:\n        prompt_parts.append(\"Ты — профессиональный юридический консультант и аналитик высшей квалификации.\")\n        prompt_parts.append(\"Твоя специализация: законодательство РФ, международное право и судебная практика.\")\n        prompt_parts.append(\"Твоя цель: давать точные, обоснованные и юридически грамотные ответы, опираясь на факты.\")\n    else:\n        prompt_parts.append(\"Ты — интеллектуальный AI-аналитик и универсальный ассистент.\")\n        prompt_parts.append(\"Твоя цель: глубоко анализировать запросы пользователя и предоставлять исчерпывающие, структурированные ответы.\")\n        prompt_parts.append(\"Ты умеешь работать с текстами, документами, строить графики и объяснять сложные концепции.\")\n\n    prompt_parts.append(\"\")\n    \n    # --- AVAILABLE TOOLS & PHILOSOPHY ---\n    prompt_parts.append(\"ДОСТУПНЫЕ ИНСТРУМЕНТЫ\")\n    prompt_parts.append(\"- general_web_search(query, time_limit, max_results): Поиск в интернете (Google/DDG).\")\n    prompt_parts.append(\"  Используй 'time_limit'='w' (неделя) или 'm' (месяц) для новостей и свежих законов.\")\n    prompt_parts.append(\"\")\n    \n    # =========================================================================\n    # CRITICAL FIX: Явное требование финального ответа\n    # =========================================================================\n    prompt_parts.append(\"ОБЯЗАТЕЛЬНЫЙ WORKFLOW (ВАЖНО!)\")\n    prompt_parts.append(\"Твоя работа состоит из двух этапов:\")\n    prompt_parts.append(\"\")\n    prompt_parts.append(\"ЭТАП 1: ПОИСК ИНФОРМАЦИИ (если нужно)\")\n    prompt_parts.append(\"Используй инструменты для получения актуальной информации.\")\n    prompt_parts.append(\"\")\n    prompt_parts.append(\"ЭТАП 2: ФИНАЛЬНЫЙ ОТВЕТ ПОЛЬЗОВАТЕЛЮ (ОБЯЗАТЕЛЬНО!)\")\n    prompt_parts.append(\"После получения результатов от инструментов ты ДОЛЖЕН:\")\n    prompt_parts.append(\"• Проанализировать полученную информацию\")\n    prompt_parts.append(\"• Сформулировать полный, структурированный ответ на РУССКОМ языке\")\n    prompt_parts.append(\"• Предоставить этот ответ пользователю в финальном сообщении\")\n    prompt_parts.append(\"\")\n    prompt_parts.append(\"⚠️ НЕ ОСТАНАВЛИВАЙСЯ после использования инструмента.\")\n    prompt_parts.append(\"⚠️ ВСЕГДА предоставляй итоговый ответ на основе найденной информации.\")\n    prompt_parts.append(\"\")\n    # =========================================================================\n    \n    prompt_parts.append(\"ФИЛОСОФИЯ ИСПОЛЬЗОВАНИЯ ПОИСКА (TOOL USAGE STRATEGY)\")\n    prompt_parts.append(\"Ты обладаешь огромной базой знаний, но мир меняется каждую секунду.\")\n    prompt_parts.append(\"1. ПРИНЦИП НЕОБХОДИМОСТИ: Не ищи информацию, которая является общеизвестным фактом (например, 'столица Франции'). Ищи только то, что может устареть (курсы валют, законы) или чего ты не знаешь (свежие новости, специфика узкой документации).\")\n    prompt_parts.append(\"2. ПРИНЦИП ТОЧНОСТИ ЗАПРОСА: Твой запрос в поиск должен быть не вопросом пользователя, а ключевыми словами для поискового движка.\")\n    prompt_parts.append(\"   - Плохо: 'Скажи мне, какие налоги платит ИП в 2025 году?'\")\n    prompt_parts.append(\"   - Хорошо: 'налоговые ставки ИП 2025 изменения РФ'\")\n    if is_legal_mode:\n        prompt_parts.append(\"3. ЮРИДИЧЕСКАЯ СПЕЦИФИКА: При поиске законов обязательно указывай номер статьи или название кодекса, если известно. Если ищешь практику — добавляй 'судебная практика' или 'пленум ВС РФ'.\")\n    else:\n        prompt_parts.append(\"3. ИТЕРАТИВНОСТЬ: Если первый поиск не дал результата, переформулируй запрос. Попробуй синонимы или более широкие термины.\")\n    \n    prompt_parts.append(\"\")\n\n    # --- OUTPUT FORMATTING ---\n    prompt_parts.append(\"ФОРМАТ ОТВЕТА\")\n    prompt_parts.append(\"Ты должен отвечать на РУССКОМ языке (если пользователь не попросил иное).\")\n    prompt_parts.append(\"Используй Markdown для структуры:\")\n    prompt_parts.append(\"- Используй заголовки ("
  },
  "code_generator": {
    "code_blocks": [
      {
        "filepath": "app/llm/prompt_templates.py",
        "language": "python",
        "code": "def format_orchestrator_prompt_general(\n    user_query: str,\n    user_files: List[Dict[str, str]] = None,\n    is_legal_mode: bool = False,\n    remaining_web_searches: int = MAX_WEB_SEARCH_CALLS,\n) -> Dict[str, str]:\n    \"\"\"\n    Строит системный и пользовательский промпты для режима General Chat.\n    \n    Args:\n        user_query: Запрос пользователя\n        user_files: Список файлов с ключами 'filename' и 'content'\n        is_legal_mode: Если True, добавляет юридическую специфику и строгость.\n        remaining_web_searches: Количество оставшихся веб-поисков\n        \n    Returns:\n        Dict с ключами \"system\" и \"user\"\n    \"\"\"\n    prompt_parts = []\n    \n    # --- ROLE DEFINITION ---\n    if is_legal_mode:\n        prompt_parts.append(\"Ты — профессиональный юридический консультант и аналитик высшей квалификации.\")\n        prompt_parts.append(\"Твоя специализация: законодательство РФ, международное право и судебная практика.\")\n        prompt_parts.append(\"Твоя цель: давать точные, обоснованные и юридически грамотные ответы, опираясь на факты.\")\n    else:\n        prompt_parts.append(\"Ты — интеллектуальный AI-аналитик и универсальный ассистент.\")\n        prompt_parts.append(\"Твоя цель: глубоко анализировать запросы пользователя и предоставлять исчерпывающие, структурированные ответы.\")\n        prompt_parts.append(\"Ты умеешь работать с текстами, документами, строить графики и объяснять сложные концепции.\")\n\n    prompt_parts.append(\"\")\n    \n    # --- AVAILABLE TOOLS & PHILOSOPHY ---\n    prompt_parts.append(\"ДОСТУПНЫЕ ИНСТРУМЕНТЫ\")\n    prompt_parts.append(\"- general_web_search(query, time_limit, max_results): Поиск в интернете (Google/DDG).\")\n    prompt_parts.append(\"  Используй 'time_limit'='w' (неделя) или 'm' (месяц) для новостей и свежих законов.\")\n    prompt_parts.append(\"\")\n    \n    # =========================================================================\n    # CRITICAL FIX: Явное требование финального ответа\n    # =========================================================================\n    prompt_parts.append(\"ОБЯЗАТЕЛЬНЫЙ WORKFLOW (ВАЖНО!)\")\n    prompt_parts.append(\"Твоя работа состоит из двух этапов:\")\n    prompt_parts.append(\"\")\n    prompt_parts.append(\"ЭТАП 1: ПОИСК ИНФОРМАЦИИ (если нужно)\")\n    prompt_parts.append(\"Используй инструменты для получения актуальной информации.\")\n    prompt_parts.append(\"\")\n    prompt_parts.append(\"ЭТАП 2: ФИНАЛЬНЫЙ ОТВЕТ ПОЛЬЗОВАТЕЛЮ (ОБЯЗАТЕЛЬНО!)\")\n    prompt_parts.append(\"После получения результатов от инструментов ты ДОЛЖЕН:\")\n    prompt_parts.append(\"• Проанализировать полученную информацию\")\n    prompt_parts.append(\"• Сформулировать полный, структурированный ответ на РУССКОМ языке\")\n    prompt_parts.append(\"• Предоставить этот ответ пользователю в финальном сообщении\")\n    prompt_parts.append(\"\")\n    prompt_parts.append(\"⚠️ НЕ ОСТАНАВЛИВАЙСЯ после использования инструмента.\")\n    prompt_parts.append(\"⚠️ ВСЕГДА предоставляй итоговый ответ на основе найденной информации.\")\n    prompt_parts.append(\"\")\n    # =========================================================================\n    \n    prompt_parts.append(\"ФИЛОСОФИЯ ИСПОЛЬЗОВАНИЯ ПОИСКА (TOOL USAGE STRATEGY)\")\n    prompt_parts.append(\"Ты обладаешь огромной базой знаний, но мир меняется каждую секунду.\")\n    prompt_parts.append(\"1. ПРИНЦИП НЕОБХОДИМОСТИ: Не ищи информацию, которая является общеизвестным фактом (например, 'столица Франции'). Ищи только то, что может устареть (курсы валют, законы) или чего ты не знаешь (свежие новости, специфика узкой документации).\")\n    prompt_parts.append(\"2. ПРИНЦИП ТОЧНОСТИ ЗАПРОСА: Твой запрос в поиск должен быть не вопросом пользователя, а ключевыми словами для поискового движка.\")\n    prompt_parts.append(\"   - Плохо: 'Скажи мне, какие налоги платит ИП в 2025 году?'\")\n    prompt_parts.append(\"   - Хорошо: 'налоговые ставки ИП 2025 изменения РФ'\")\n    if is_legal_mode:\n        prompt_parts.append(\"3. ЮРИДИЧЕСКАЯ СПЕЦИФИКА: При поиске законов обязательно указывай номер статьи или название кодекса, если известно. Если ищешь практику — добавляй 'судебная практика' или 'пленум ВС РФ'.\")\n    else:\n        prompt_parts.append(\"3. ИТЕРАТИВНОСТЬ: Если первый поиск не дал результата, переформулируй запрос. Попробуй синонимы или более широкие термины.\")\n    \n    prompt_parts.append(\"\")\n\n    # --- OUTPUT FORMATTING ---\n    prompt_parts.append(\"ФОРМАТ ОТВЕТА\")\n    prompt_parts.append(\"Ты должен отвечать на РУССКОМ языке (если пользователь не попросил иное).\")\n    prompt_parts.append(\"Используй Markdown для структуры:\")\n    prompt_parts.append(\"- Используй заголовки (##) для разделения тем.\")\n    prompt_parts.append(\"- Используй таблицы (| ... |) для сравнения данных.\")\n    if is_legal_mode:\n        prompt_parts.append(\"- ОБЯЗАТЕЛЬНО: Ссылайся на конкретные статьи законов (ст. X ГК РФ).\")\n        prompt_parts.append(\"- Выделяй важные сроки и штрафы жирным шрифтом.\")\n        prompt_parts.append(\"- Если вопрос спорный, приведи аргументы 'За' и 'Против'.\")\n    else:\n        prompt_parts.append(\"- Если нужно показать алгоритм — используй псевдокод в блоках кода.\")\n        prompt_parts.append(\"- Если данные подходят для графика — предложи его текстовое описание или ASCII-график.\")\n\n    prompt_parts.append(\"\")\n    \n    # --- CONTEXT HANDLING ---\n    prompt_parts.append(\"РАБОТА С ФАЙЛАМИ ПОЛЬЗОВАТЕЛЯ\")\n    prompt_parts.append(\"Пользователь может прикрепить файлы (текст, PDF, таблицы). Они будут переданы тебе в сообщении.\")\n    prompt_parts.append(\"Анализируй их содержимое внимательно. Если пользователь спрашивает по файлу — отвечай строго по нему.\")\n    prompt_parts.append(\"Если в файлах нет ответа — скажи об этом и предложи поискать в интернете.\")\n    \n    # --- BUILD USER PROMPT ---\n    user_prompt_parts = []\n    user_prompt_parts.append(user_query)\n    \n    if user_files:\n        user_prompt_parts.append(\"\")\n        user_prompt_parts.append(\"Прикреплённые файлы:\")\n        for file_info in user_files:\n            filename = file_info.get('filename', 'Без названия')\n            content = file_info.get('content', '')\n            user_prompt_parts.append(f\"--- Файл: {filename} ---\")\n            user_prompt_parts.append(content)\n            user_prompt_parts.append(\"--- Конец файла ---\")\n    \n    # --- RETURN DICT ---\n    return {\n        \"system\": \"\\n\".join(prompt_parts),\n        \"user\": \"\\n\".join(user_prompt_parts)\n    }",
        "context": "format_orchestrator_prompt_general function"
      },
      {
        "filepath": "app/llm/prompt_templates.py",
        "language": "python",
        "code": "prompts = format_orchestrator_prompt_general(\n    user_query=\"Какой налог платят ИП в 2025 году?\",\n    user_files=[{\"filename\": \"договор.txt\", \"content\": \"Текст договора...\"}],\n    is_legal_mode=True\n)\n\n# prompts[\"system\"] - системный промпт с инструкциями\n# prompts[\"user\"] - пользовательский промпт с запросом и файлами",
        "context": null
      }
    ],
    "explanation": "Функция `format_orchestrator_prompt_general` была исправлена для возврата словаря вместо строки, что приводит её в соответствие с другими функциями форматирования промптов в проекте.\n\n**Основные изменения:**\n\n1. **Разделение логики на системный и пользовательский промпты:**\n   - Вся существующая логика построения системного промпта сохранена без изменений\n   - Добавлена новая логика для построения пользовательского промпта\n\n2. **Построение пользовательского промпта:**\n   - Включает оригинальный запрос пользователя (`user_query`)\n   - Если есть прикреплённые файлы (`user_files`), добавляет их содержимое с чёткими разделителями\n   - Форматирует файлы с указанием имени и содержимого для удобства анализа\n\n3. **Возвращаемое значение:**\n   - Теперь функция возвращает словарь с ключами `\"system\"` и `\"user\"`\n   - Системный промпт содержит инструкции для модели AI\n   - Пользовательский промпт содержит запрос и файлы пользователя\n\n4. **Совместимость:**\n   - Функция теперь соответствует интерфейсу других функций форматирования промптов\n   - Сохраняет обратную совместимость по параметрам\n   - Документация обновлена для отражения новых возможностей\n\n**Как использовать:**\n\n\n**Важное замечание:** Функция теперь возвращает структурированные данные, которые можно напрямую использовать в системах, ожидающих раздельные системные и пользовательские промпты.",
    "frontend_json": {
      "success": true,
      "code_blocks": [
        {
          "code": "def format_orchestrator_prompt_general(\n    user_query: str,\n    user_files: List[Dict[str, str]] = None,\n    is_legal_mode: bool = False,\n    remaining_web_searches: int = MAX_WEB_SEARCH_CALLS,\n) -> Dict[str, str]:\n    \"\"\"\n    Строит системный и пользовательский промпты для режима General Chat.\n    \n    Args:\n        user_query: Запрос пользователя\n        user_files: Список файлов с ключами 'filename' и 'content'\n        is_legal_mode: Если True, добавляет юридическую специфику и строгость.\n        remaining_web_searches: Количество оставшихся веб-поисков\n        \n    Returns:\n        Dict с ключами \"system\" и \"user\"\n    \"\"\"\n    prompt_parts = []\n    \n    # --- ROLE DEFINITION ---\n    if is_legal_mode:\n        prompt_parts.append(\"Ты — профессиональный юридический консультант и аналитик высшей квалификации.\")\n        prompt_parts.append(\"Твоя специализация: законодательство РФ, международное право и судебная практика.\")\n        prompt_parts.append(\"Твоя цель: давать точные, обоснованные и юридически грамотные ответы, опираясь на факты.\")\n    else:\n        prompt_parts.append(\"Ты — интеллектуальный AI-аналитик и универсальный ассистент.\")\n        prompt_parts.append(\"Твоя цель: глубоко анализировать запросы пользователя и предоставлять исчерпывающие, структурированные ответы.\")\n        prompt_parts.append(\"Ты умеешь работать с текстами, документами, строить графики и объяснять сложные концепции.\")\n\n    prompt_parts.append(\"\")\n    \n    # --- AVAILABLE TOOLS & PHILOSOPHY ---\n    prompt_parts.append(\"ДОСТУПНЫЕ ИНСТРУМЕНТЫ\")\n    prompt_parts.append(\"- general_web_search(query, time_limit, max_results): Поиск в интернете (Google/DDG).\")\n    prompt_parts.append(\"  Используй 'time_limit'='w' (неделя) или 'm' (месяц) для новостей и свежих законов.\")\n    prompt_parts.append(\"\")\n    \n    # =========================================================================\n    # CRITICAL FIX: Явное требование финального ответа\n    # =========================================================================\n    prompt_parts.append(\"ОБЯЗАТЕЛЬНЫЙ WORKFLOW (ВАЖНО!)\")\n    prompt_parts.append(\"Твоя работа состоит из двух этапов:\")\n    prompt_parts.append(\"\")\n    prompt_parts.append(\"ЭТАП 1: ПОИСК ИНФОРМАЦИИ (если нужно)\")\n    prompt_parts.append(\"Используй инструменты для получения актуальной информации.\")\n    prompt_parts.append(\"\")\n    prompt_parts.append(\"ЭТАП 2: ФИНАЛЬНЫЙ ОТВЕТ ПОЛЬЗОВАТЕЛЮ (ОБЯЗАТЕЛЬНО!)\")\n    prompt_parts.append(\"После получения результатов от инструментов ты ДОЛЖЕН:\")\n    prompt_parts.append(\"• Проанализировать полученную информацию\")\n    prompt_parts.append(\"• Сформулировать полный, структурированный ответ на РУССКОМ языке\")\n    prompt_parts.append(\"• Предоставить этот ответ пользователю в финальном сообщении\")\n    prompt_parts.append(\"\")\n    prompt_parts.append(\"⚠️ НЕ ОСТАНАВЛИВАЙСЯ после использования инструмента.\")\n    prompt_parts.append(\"⚠️ ВСЕГДА предоставляй итоговый ответ на основе найденной информации.\")\n    prompt_parts.append(\"\")\n    # =========================================================================\n    \n    prompt_parts.append(\"ФИЛОСОФИЯ ИСПОЛЬЗОВАНИЯ ПОИСКА (TOOL USAGE STRATEGY)\")\n    prompt_parts.append(\"Ты обладаешь огромной базой знаний, но мир меняется каждую секунду.\")\n    prompt_parts.append(\"1. ПРИНЦИП НЕОБХОДИМОСТИ: Не ищи информацию, которая является общеизвестным фактом (например, 'столица Франции'). Ищи только то, что может устареть (курсы валют, законы) или чего ты не знаешь (свежие новости, специфика узкой документации).\")\n    prompt_parts.append(\"2. ПРИНЦИП ТОЧНОСТИ ЗАПРОСА: Твой запрос в поиск должен быть не вопросом пользователя, а ключевыми словами для поискового движка.\")\n    prompt_parts.append(\"   - Плохо: 'Скажи мне, какие налоги платит ИП в 2025 году?'\")\n    prompt_parts.append(\"   - Хорошо: 'налоговые ставки ИП 2025 изменения РФ'\")\n    if is_legal_mode:\n        prompt_parts.append(\"3. ЮРИДИЧЕСКАЯ СПЕЦИФИКА: При поиске законов обязательно указывай номер статьи или название кодекса, если известно. Если ищешь практику — добавляй 'судебная практика' или 'пленум ВС РФ'.\")\n    else:\n        prompt_parts.append(\"3. ИТЕРАТИВНОСТЬ: Если первый поиск не дал результата, переформулируй запрос. Попробуй синонимы или более широкие термины.\")\n    \n    prompt_parts.append(\"\")\n\n    # --- OUTPUT FORMATTING ---\n    prompt_parts.append(\"ФОРМАТ ОТВЕТА\")\n    prompt_parts.append(\"Ты должен отвечать на РУССКОМ языке (если пользователь не попросил иное).\")\n    prompt_parts.append(\"Используй Markdown для структуры:\")\n    prompt_parts.append(\"- Используй заголовки (##) для разделения тем.\")\n    prompt_parts.append(\"- Используй таблицы (| ... |) для сравнения данных.\")\n    if is_legal_mode:\n        prompt_parts.append(\"- ОБЯЗАТЕЛЬНО: Ссылайся на конкретные статьи законов (ст. X ГК РФ).\")\n        prompt_parts.append(\"- Выделяй важные сроки и штрафы жирным шрифтом.\")\n        prompt_parts.append(\"- Если вопрос спорный, приведи аргументы 'За' и 'Против'.\")\n    else:\n        prompt_parts.append(\"- Если нужно показать алгоритм — используй псевдокод в блоках кода.\")\n        prompt_parts.append(\"- Если данные подходят для графика — предложи его текстовое описание или ASCII-график.\")\n\n    prompt_parts.append(\"\")\n    \n    # --- CONTEXT HANDLING ---\n    prompt_parts.append(\"РАБОТА С ФАЙЛАМИ ПОЛЬЗОВАТЕЛЯ\")\n    prompt_parts.append(\"Пользователь может прикрепить файлы (текст, PDF, таблицы). Они будут переданы тебе в сообщении.\")\n    prompt_parts.append(\"Анализируй их содержимое внимательно. Если пользователь спрашивает по файлу — отвечай строго по нему.\")\n    prompt_parts.append(\"Если в файлах нет ответа — скажи об этом и предложи поискать в интернете.\")\n    \n    # --- BUILD USER PROMPT ---\n    user_prompt_parts = []\n    user_prompt_parts.append(user_query)\n    \n    if user_files:\n        user_prompt_parts.append(\"\")\n        user_prompt_parts.append(\"Прикреплённые файлы:\")\n        for file_info in user_files:\n            filename = file_info.get('filename', 'Без названия')\n            content = file_info.get('content', '')\n            user_prompt_parts.append(f\"--- Файл: {filename} ---\")\n            user_prompt_parts.append(content)\n            user_prompt_parts.append(\"--- Конец файла ---\")\n    \n    # --- RETURN DICT ---\n    return {\n        \"system\": \"\\n\".join(prompt_parts),\n        \"user\": \"\\n\".join(user_prompt_parts)\n    }",
          "filepath": "app/llm/prompt_templates.py",
          "language": "python",
          "context": "format_orchestrator_prompt_general function"
        },
        {
          "code": "prompts = format_orchestrator_prompt_general(\n    user_query=\"Какой налог платят ИП в 2025 году?\",\n    user_files=[{\"filename\": \"договор.txt\", \"content\": \"Текст договора...\"}],\n    is_legal_mode=True\n)\n\n# prompts[\"system\"] - системный промпт с инструкциями\n# prompts[\"user\"] - пользовательский промпт с запросом и файлами",
          "filepath": "app/llm/prompt_templates.py",
          "language": "python",
          "context": null
        }
      ],
      "combined_code": "\n\n# ==================================================# filepath: app/llm/prompt_templates.py\n# context: format_orchestrator_prompt_general function\n\ndef format_orchestrator_prompt_general(\n    user_query: str,\n    user_files: List[Dict[str, str]] = None,\n    is_legal_mode: bool = False,\n    remaining_web_searches: int = MAX_WEB_SEARCH_CALLS,\n) -> Dict[str, str]:\n    \"\"\"\n    Строит системный и пользовательский промпты для режима General Chat.\n    \n    Args:\n        user_query: Запрос пользователя\n        user_files: Список файлов с ключами 'filename' и 'content'\n        is_legal_mode: Если True, добавляет юридическую специфику и строгость.\n        remaining_web_searches: Количество оставшихся веб-поисков\n        \n    Returns:\n        Dict с ключами \"system\" и \"user\"\n    \"\"\"\n    prompt_parts = []\n    \n    # --- ROLE DEFINITION ---\n    if is_legal_mode:\n        prompt_parts.append(\"Ты — профессиональный юридический консультант и аналитик высшей квалификации.\")\n        prompt_parts.append(\"Твоя специализация: законодательство РФ, международное право и судебная практика.\")\n        prompt_parts.append(\"Твоя цель: давать точные, обоснованные и юридически грамотные ответы, опираясь на факты.\")\n    else:\n        prompt_parts.append(\"Ты — интеллектуальный AI-аналитик и универсальный ассистент.\")\n        prompt_parts.append(\"Твоя цель: глубоко анализировать запросы пользователя и предоставлять исчерпывающие, структурированные ответы.\")\n        prompt_parts.append(\"Ты умеешь работать с текстами, документами, строить графики и объяснять сложные концепции.\")\n\n    prompt_parts.append(\"\")\n    \n    # --- AVAILABLE TOOLS & PHILOSOPHY ---\n    prompt_parts.append(\"ДОСТУПНЫЕ ИНСТРУМЕНТЫ\")\n    prompt_parts.append(\"- general_web_search(query, time_limit, max_results): Поиск в интернете (Google/DDG).\")\n    prompt_parts.append(\"  Используй 'time_limit'='w' (неделя) или 'm' (месяц) для новостей и свежих законов.\")\n    prompt_parts.append(\"\")\n    \n    # =========================================================================\n    # CRITICAL FIX: Явное требование финального ответа\n    # =========================================================================\n    prompt_parts.append(\"ОБЯЗАТЕЛЬНЫЙ WORKFLOW (ВАЖНО!)\")\n    prompt_parts.append(\"Твоя работа состоит из двух этапов:\")\n    prompt_parts.append(\"\")\n    prompt_parts.append(\"ЭТАП 1: ПОИСК ИНФОРМАЦИИ (если нужно)\")\n    prompt_parts.append(\"Используй инструменты для получения актуальной информации.\")\n    prompt_parts.append(\"\")\n    prompt_parts.append(\"ЭТАП 2: ФИНАЛЬНЫЙ ОТВЕТ ПОЛЬЗОВАТЕЛЮ (ОБЯЗАТЕЛЬНО!)\")\n    prompt_parts.append(\"После получения результатов от инструментов ты ДОЛЖЕН:\")\n    prompt_parts.append(\"• Проанализировать полученную информацию\")\n    prompt_parts.append(\"• Сформулировать полный, структурированный ответ на РУССКОМ языке\")\n    prompt_parts.append(\"• Предоставить этот ответ пользователю в финальном сообщении\")\n    prompt_parts.append(\"\")\n    prompt_parts.append(\"⚠️ НЕ ОСТАНАВЛИВАЙСЯ после использования инструмента.\")\n    prompt_parts.append(\"⚠️ ВСЕГДА предоставляй итоговый ответ на основе найденной информации.\")\n    prompt_parts.append(\"\")\n    # =========================================================================\n    \n    prompt_parts.append(\"ФИЛОСОФИЯ ИСПОЛЬЗОВАНИЯ ПОИСКА (TOOL USAGE STRATEGY)\")\n    prompt_parts.append(\"Ты обладаешь огромной базой знаний, но мир меняется каждую секунду.\")\n    prompt_parts.append(\"1. ПРИНЦИП НЕОБХОДИМОСТИ: Не ищи информацию, которая является общеизвестным фактом (например, 'столица Франции'). Ищи только то, что может устареть (курсы валют, законы) или чего ты не знаешь (свежие новости, специфика узкой документации).\")\n    prompt_parts.append(\"2. ПРИНЦИП ТОЧНОСТИ ЗАПРОСА: Твой запрос в поиск должен быть не вопросом пользователя, а ключевыми словами для поискового движка.\")\n    prompt_parts.append(\"   - Плохо: 'Скажи мне, какие налоги платит ИП в 2025 году?'\")\n    prompt_parts.append(\"   - Хорошо: 'налоговые ставки ИП 2025 изменения РФ'\")\n    if is_legal_mode:\n        prompt_parts.append(\"3. ЮРИДИЧЕСКАЯ СПЕЦИФИКА: При поиске законов обязательно указывай номер статьи или название кодекса, если известно. Если ищешь практику — добавляй 'судебная практика' или 'пленум ВС РФ'.\")\n    else:\n        prompt_parts.append(\"3. ИТЕРАТИВНОСТЬ: Если первый поиск не дал результата, переформулируй запрос. Попробуй синонимы или более широкие термины.\")\n    \n    prompt_parts.append(\"\")\n\n    # --- OUTPUT FORMATTING ---\n    prompt_parts.append(\"ФОРМАТ ОТВЕТА\")\n    prompt_parts.append(\"Ты должен отвечать на РУССКОМ языке (если пользователь не попросил иное).\")\n    prompt_parts.append(\"Используй Markdown для структуры:\")\n    prompt_parts.append(\"- Используй заголовки (##) для разделения тем.\")\n    prompt_parts.append(\"- Используй таблицы (| ... |) для сравнения данных.\")\n    if is_legal_mode:\n        prompt_parts.append(\"- ОБЯЗАТЕЛЬНО: Ссылайся на конкретные статьи законов (ст. X ГК РФ).\")\n        prompt_parts.append(\"- Выделяй важные сроки и штрафы жирным шрифтом.\")\n        prompt_parts.append(\"- Если вопрос спорный, приведи аргументы 'За' и 'Против'.\")\n    else:\n        prompt_parts.append(\"- Если нужно показать алгоритм — используй псевдокод в блоках кода.\")\n        prompt_parts.append(\"- Если данные подходят для графика — предложи его текстовое описание или ASCII-график.\")\n\n    prompt_parts.append(\"\")\n    \n    # --- CONTEXT HANDLING ---\n    prompt_parts.append(\"РАБОТА С ФАЙЛАМИ ПОЛЬЗОВАТЕЛЯ\")\n    prompt_parts.append(\"Пользователь может прикрепить файлы (текст, PDF, таблицы). Они будут переданы тебе в сообщении.\")\n    prompt_parts.append(\"Анализируй их содержимое внимательно. Если пользователь спрашивает по файлу — отвечай строго по нему.\")\n    prompt_parts.append(\"Если в файлах нет ответа — скажи об этом и предложи поискать в интернете.\")\n    \n    # --- BUILD USER PROMPT ---\n    user_prompt_parts = []\n    user_prompt_parts.append(user_query)\n    \n    if user_files:\n        user_prompt_parts.append(\"\")\n        user_prompt_parts.append(\"Прикреплённые файлы:\")\n        for file_info in user_files:\n            filename = file_info.get('filename', 'Без названия')\n            content = file_info.get('content', '')\n            user_prompt_parts.append(f\"--- Файл: {filename} ---\")\n            user_prompt_parts.append(content)\n            user_prompt_parts.append(\"--- Конец файла ---\")\n    \n    # --- RETURN DICT ---\n    return {\n        \"system\": \"\\n\".join(prompt_parts),\n        \"user\": \"\\n\".join(user_prompt_parts)\n    }\n\n# filepath: app/llm/prompt_templates.py\n\nprompts = format_orchestrator_prompt_general(\n    user_query=\"Какой налог платят ИП в 2025 году?\",\n    user_files=[{\"filename\": \"договор.txt\", \"content\": \"Текст договора...\"}],\n    is_legal_mode=True\n)\n\n# prompts[\"system\"] - системный промпт с инструкциями\n# prompts[\"user\"] - пользовательский промпт с запросом и файлами",
      "explanation": "Функция `format_orchestrator_prompt_general` была исправлена для возврата словаря вместо строки, что приводит её в соответствие с другими функциями форматирования промптов в проекте.\n\n**Основные изменения:**\n\n1. **Разделение логики на системный и пользовательский промпты:**\n   - Вся существующая логика построения системного промпта сохранена без изменений\n   - Добавлена новая логика для построения пользовательского промпта\n\n2. **Построение пользовательского промпта:**\n   - Включает оригинальный запрос пользователя (`user_query`)\n   - Если есть прикреплённые файлы (`user_files`), добавляет их содержимое с чёткими разделителями\n   - Форматирует файлы с указанием имени и содержимого для удобства анализа\n\n3. **Возвращаемое значение:**\n   - Теперь функция возвращает словарь с ключами `\"system\"` и `\"user\"`\n   - Системный промпт содержит инструкции для модели AI\n   - Пользовательский промпт содержит запрос и файлы пользователя\n\n4. **Совместимость:**\n   - Функция теперь соответствует интерфейсу других функций форматирования промптов\n   - Сохраняет обратную совместимость по параметрам\n   - Документация обновлена для отражения новых возможностей\n\n**Как использовать:**\n\n\n**Важное замечание:** Функция теперь возвращает структурированные данные, которые можно напрямую использовать в системах, ожидающих раздельные системные и пользовательские промпты.",
      "error": null,
      "model_used": "deepseek-chat",
      "tokens_used": 0
    }
  }
}