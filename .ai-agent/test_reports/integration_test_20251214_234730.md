# ü§ñ AI Code Agent - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –¢–µ—Å—Ç

**–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 14.12.2025 23:47:30
**–ü—Ä–æ–µ–∫—Ç:** `C:\Users\Admin\AI_Assistant_Pro`
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 109.62 —Å–µ–∫.

---

## üìù –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

> # –ó–ê–î–ê–ß–ê: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è app/history/compressor.py–í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–∞ `compressor.py` –µ—Å—Ç—å –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –µ–≥–æ –Ω–µ—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω—ã–º.**–ò—Å–ø—Ä–∞–≤—å —Å–ª–µ–¥—É—é—â–∏–µ –ø—É–Ω–∫—Ç—ã (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):**1.  üî¥ **–£–î–ê–õ–ò–¢–¨ –ö–û–î –í –ö–û–ù–¶–ï –§–ê–ô–õ–ê:**    –£–¥–∞–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è `await compress_history_if_needed(...)` –∏ `prune_irrelevant_context(...)` –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ. –≠—Ç–æ –ª–æ–º–∞–µ—Ç –∏–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è.2.  üî¥ **–ò–ó–ú–ï–ù–ò–¢–¨ –î–ï–§–û–õ–¢–ù–´–ô –ü–û–†–û–ì:**    –í —Ñ—É–Ω–∫—Ü–∏–∏ `compress_history_if_needed` —É—Å—Ç–∞–Ω–æ–≤–∏ `threshold: int = 30000` (–≤–º–µ—Å—Ç–æ 8000).3.  üî¥ **–ü–ï–†–ï–ü–ò–°–ê–¢–¨ `prune_irrelevant_context`:**    *   –ò—Å–ø–æ–ª—å–∑—É–π —É–ª—É—á—à–µ–Ω–Ω—ã–π regex –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤:        `r'[\w/\-]+\.(?:py|js|ts|sql|json|md|txt|html|css|go|java|cpp|c|rs|rb)|\b(?:src|lib|app|tests|config)/[\w/.-]+'`    *   –ê–ª–≥–æ—Ä–∏—Ç–º:        1. –ù–∞–π—Ç–∏ —Ñ–∞–π–ª—ã –≤ `current_query` (`mentioned_files`).        2. –ï—Å–ª–∏ `mentioned_files` –ø—É—Å—Ç–æ ‚Äî –≤–µ—Ä–Ω—É—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–∞–∫ –µ—Å—Ç—å.        3. –ü—Ä–æ–π—Ç–∏ –ø–æ `role='tool'`.        4. –ù–∞–π—Ç–∏ —Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ `msg.content` (`content_files`).        5. –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:           * –ï—Å–ª–∏ `content_files` –ù–ï –ø—É—Å—Ç –ò –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ `content_files` —Å `mentioned_files` –ü–£–°–¢–û ‚Üí –∑–Ω–∞—á–∏—Ç, —ç—Ç–æ –º—É—Å–æ—Ä.           * –ó–∞–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ `[PRUNED: {file} –±—ã–ª –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ]`.           * –ò–Ω–∞—á–µ (–µ—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ –Ω—É–∂–Ω—ã) ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.4.  üî¥ **–î–û–ë–ê–í–ò–¢–¨ –õ–û–ì–ò–†–û–í–ê–ù–ò–ï:**    –í `compress_history_if_needed` –¥–æ–±–∞–≤—å –ª–æ–≥ –ø—Ä–∏ –ø—Ä–æ–ø—É—Å–∫–µ —Å–∂–∞—Ç–∏—è –∏–∑-–∑–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–¥–∞:    `logger.debug(f"Skipping compression for assistant message {msg.id} due to code block")`**–í—ã–¥–∞–π –ü–û–õ–ù–´–ô –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ —Ñ–∞–π–ª–∞ `compressor.py`.**

---

## üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏

- **Orchestrator:** Claude Opus 4.5 (RouterAI)
- **Code Generator:** deepseek-chat

---

## üîç –ê–Ω–∞–ª–∏–∑ –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞

–í —Ñ–∞–π–ª–µ `app/history/compressor.py` –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–°—Ç—Ä–æ–∫–∏ 188-190**: –ù–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è `await compress_history_if_needed(...)` –∏ `prune_irrelevant_context(...)`. –≠—Ç–æ –ª–æ–º–∞–µ—Ç –∏–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è, —Ç–∞–∫ –∫–∞–∫:
   - `await` –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω–µ async-—Ñ—É–Ω–∫—Ü–∏–∏
   - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `history` –∏ `current_query` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ

2. **–°—Ç—Ä–æ–∫–∞ 38**: –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø–æ—Ä–æ–≥ `threshold: int = 8000` —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π, –Ω—É–∂–Ω–æ `30000`.

3. **–§—É–Ω–∫—Ü–∏—è `prune_irrelevant_context` (—Å—Ç—Ä–æ–∫–∏ 143-186)**: 
   - –¢–µ–∫—É—â–∏–π regex —Å–ª–∏—à–∫–æ–º –ø—Ä–æ—Å—Ç–æ–π –∏ –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
   - –õ–æ–≥–∏–∫–∞ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞: —Å–µ–π—á–∞—Å –æ–Ω–∞ –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ —Ñ–∞–π–ª—ã –∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ, –Ω–æ –Ω—É–∂–Ω–æ –Ω–∞–æ–±–æ—Ä–æ—Ç ‚Äî —É–¥–∞–ª—è—Ç—å, –µ—Å–ª–∏ —Ñ–∞–π–ª—ã –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ –ù–ï –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è —Å —Ñ–∞–π–ª–∞–º–∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞

4. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í `compress_history_if_needed` –ø—Ä–∏ –ø—Ä–æ–ø—É—Å–∫–µ —Å–∂–∞—Ç–∏—è –∏–∑-–∑–∞ –±–ª–æ–∫–∞ –∫–æ–¥–∞ –Ω–µ—Ç debug-–ª–æ–≥–∞.

---

## üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Code Generator

**Task:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ compressor.py: —É–¥–∞–ª–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã, –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä–æ–≥, –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å prune_irrelevant_context —Å –Ω–æ–≤—ã–º regex –∏ –ª–æ–≥–∏–∫–æ–π, –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.

**File:** `app/history/compressor.py`

**Location:** –í–µ—Å—å —Ñ–∞–π–ª —Ç—Ä–µ–±—É–µ—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏

**Changes:**

1. **–£–î–ê–õ–ò–¢–¨ —Å—Ç—Ä–æ–∫–∏ 188-190** (–∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞):
   –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏:
   ```python
   compressed_history = await compress_history_if_needed(history, threshold=8000)
   pruned_history = prune_irrelevant_context(history, current_query)
   ```
   –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–æ–∫–µ 186 (–∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ `prune_irrelevant_context`).

2. **–ò–ó–ú–ï–ù–ò–¢–¨ —Å—Ç—Ä–æ–∫—É 38** ‚Äî —Å–∏–≥–Ω–∞—Ç—É—Ä—É —Ñ—É–Ω–∫—Ü–∏–∏ `compress_history_if_needed`:
   –ó–∞–º–µ–Ω–∏—Ç—å:
   ```python
   async def compress_history_if_needed(history: List[Message], threshold: int = 8000) -> List[Message]:
   ```
   –ù–∞:
   ```python
   async def compress_history_if_needed(history: List[Message], threshold: int = 30000) -> List[Message]:
   ```

3. **–ò–ó–ú–ï–ù–ò–¢–¨ —Å—Ç—Ä–æ–∫—É 45** ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å docstring:
   –ó–∞–º–µ–Ω–∏—Ç—å:
   ```python
   threshold: –ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Å–∂–∞—Ç–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 8000).
   ```
   –ù–∞:
   ```python
   threshold: –ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Å–∂–∞—Ç–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30000).
   ```

4. **–î–û–ë–ê–í–ò–¢–¨ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±–ª–æ–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ assistant-—Å–æ–æ–±—â–µ–Ω–∏–π** (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 67):
   –í —Ñ—É–Ω–∫—Ü–∏–∏ `compress_history_if_needed`, –≤ —Ü–∏–∫–ª–µ `for msg in to_compress:`, –≤ –≤–µ—Ç–∫–µ `elif msg.role == 'assistant':`, –ü–ï–†–ï–î –≤—ã–∑–æ–≤–æ–º `_compress_message` –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º:
   ```python
   elif msg.role == 'assistant':
       if _contains_code_block(msg.content):
           logger.debug(f"Skipping compression for assistant message {msg.id} due to code block")
           compressed_history.append(msg)
       else:
           compressed_msg = await _compress_message(msg, "reasoning")
           compressed_history.append(compressed_msg)
   ```
   –≠—Ç–æ –∑–∞–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–µ —Å—Ç—Ä–æ–∫–∏ 67-69.

5. **–ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–ü–ò–°–ê–¢–¨ —Ñ—É–Ω–∫—Ü–∏—é `prune_irrelevant_context`** (—Å—Ç—Ä–æ–∫–∏ 143-186):
   –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å—é —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é:

   ```python
   def prune_irrelevant_context(history: List[Message], current_query: str) -> List[Message]:
       """
       –£–¥–∞–ª—è–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–π–ª–æ–≤,
       —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –≤ —Ç–µ–∫—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ.

       Args:
           history: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
           current_query: –¢–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

       Returns:
           –ò—Å—Ç–æ—Ä–∏—è —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º–∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
       """
       # –£–ª—É—á—à–µ–Ω–Ω—ã–π regex –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
       file_pattern = r'[\w/\-]+\.(?:py|js|ts|sql|json|md|txt|html|css|go|java|cpp|c|rs|rb)|\b(?:src|lib|app|tests|config)/[\w/.-]+'
       
       # –ò–∑–≤–ª–µ–∫–∞–µ–º —É–ø–æ–º—è–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
       mentioned_files = set(re.findall(file_pattern, current_query))
       
       # –ï—Å–ª–∏ —Ñ–∞–π–ª—ã –Ω–µ —É–ø–æ–º—è–Ω—É—Ç—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
       if not mentioned_files:
           return history
       
       pruned_history = []
       
       for msg in history:
           if msg.role != 'tool':
               pruned_history.append(msg)
           else:
               # –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
               content_files = set(re.findall(file_pattern, msg.content))
               
               # –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:
               # –ï—Å–ª–∏ content_files –ù–ï –ø—É—Å—Ç –ò –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å mentioned_files –ü–£–°–¢–û ‚Üí —ç—Ç–æ –º—É—Å–æ—Ä
               if content_files and not content_files.intersection(mentioned_files):
                   # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
                   first_file = next(iter(content_files), "unknown")
                   pruned_content = f"[PRUNED: {first_file} –±—ã–ª –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ]"
                   pruned_msg = Message(
                       id=msg.id,
                       thread_id=msg.thread_id,
                       role=msg.role,
                       content=pruned_content,
                       tokens=TokenCounter().count(pruned_content),
                       metadata=msg.metadata,
                       created_at=msg.created_at
                   )
                   pruned_history.append(pruned_msg)
               else:
                   # –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ –Ω—É–∂–Ω—ã ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                   pruned_history.append(msg)
       
       return pruned_history
   ```

**Why:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª—è:
- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã async-—Ñ—É–Ω–∫—Ü–∏–π –ª–æ–º–∞—é—Ç –∏–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—è
- –ü–æ—Ä–æ–≥ 8000 —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
- –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ prune_irrelevant_context –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –ø—Ä–æ–ø—É—Å–∫ —Å–∂–∞—Ç–∏—è

---

## üíª –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥

**–§–∞–π–ª:** `app/history/compressor.py`

```python
"""
–ú–æ–¥—É–ª—å –¥–ª—è —Å–∂–∞—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ –ª–µ—Ç—É –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î (—Ä–µ–∂–∏–º Recompute).
–†–µ–∞–ª–∏–∑—É–µ—Ç –¥–≤–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:
1. –¢–æ–∫–µ–Ω-–±–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ: —Å–∂–∏–º–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é LLM,
   —Å–æ—Ö—Ä–∞–Ω—è—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–ª–æ–∫–∏ –∫–æ–¥–∞.
2. –û–±—Ä–µ–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: —É–¥–∞–ª—è–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
"""

import asyncio
import logging
import re
from typing import List, Optional
from dataclasses import dataclass
from app.llm.prompt_templates import format_compression_prompt
from app.history.storage import Message
from app.utils.token_counter import TokenCounter
from app.llm.api_client import call_llm
from config.settings import cfg

logger = logging.getLogger(__name__)


def _contains_code_block(content: str) -> bool:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ç–µ–∫—Å—Ç –±–ª–æ–∫–∏ –∫–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown (—Ç—Ä–æ–π–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏).
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç chr(96)*3 –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–∞–≤—ã—á–µ–∫ –≤ –∫–æ–¥–µ.

    Args:
        content: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.

    Returns:
        True, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –±–ª–æ–∫–∏ –∫–æ–¥–∞, –∏–Ω–∞—á–µ False.
    """
    triple_backticks = chr(96) * 3
    return triple_backticks in content


async def compress_history_if_needed(history: List[Message], threshold: int = 30000) -> List[Message]:
    """
    –°–∂–∏–º–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏, –∞ —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–∂–∏–º–∞–µ—Ç —Å –ø–æ–º–æ—â—å—é LLM.

    Args:
        history: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
        threshold: –ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Å–∂–∞—Ç–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30000).

    Returns:
        –°–∂–∞—Ç—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ —Å–∂–∞—Ç–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.
    """
    token_counter = TokenCounter()
    total_tokens = sum(token_counter.count(msg.content) for msg in history)
    
    if total_tokens <= threshold:
        return history
    
    compressed_history = []
    keep_last_n = 3
    
    # –†–∞–∑–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —á–∞—Å—Ç—å –¥–ª—è —Å–∂–∞—Ç–∏—è –∏ —á–∞—Å—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    to_compress = history[:-keep_last_n] if len(history) > keep_last_n else []
    keep_intact = history[-keep_last_n:] if len(history) > keep_last_n else history
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Å–∂–∞—Ç–∏—è
    for msg in to_compress:
        if msg.role == 'user':
            compressed_history.append(msg)
        elif msg.role == 'assistant':
            if _contains_code_block(msg.content):
                logger.debug(f"Skipping compression for assistant message {msg.id} due to code block")
                compressed_history.append(msg)
            else:
                compressed_msg = await _compress_message(msg, "reasoning")
                compressed_history.append(compressed_msg)
        elif msg.role == 'tool':
            compressed_msg = await _compress_message(msg, "tool_result")
            compressed_history.append(compressed_msg)
        else:
            compressed_history.append(msg)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    compressed_history.extend(keep_intact)
    
    # –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∂–∞—Ç–∏—è
    compressed_tokens = sum(token_counter.count(msg.content) for msg in compressed_history)
    logger.info(f"History compressed: {total_tokens} ‚Üí {compressed_tokens} tokens "
                f"({compressed_tokens/total_tokens*100:.1f}% of original)")
    
    return compressed_history


async def _compress_message(msg: Message, content_type: str) -> Message:
    """
    –°–∂–∏–º–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é LLM, –∏—Å–ø–æ–ª—å–∑—É—è —à–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤.
    –ù–µ —Å–∂–∏–º–∞–µ—Ç —É–∂–µ —Å–∂–∞—Ç—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–ª–æ–∫–∞–º–∏ –∫–æ–¥–∞.

    Args:
        msg: –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Å–∂–∞—Ç–∏—è.
        content_type: –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ('reasoning' –∏–ª–∏ 'tool_result').

    Returns:
        –°–∂–∞—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–∂–∞—Ç–æ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ
    if msg.content.startswith("[COMPRESSED]"):
        return msg
    
    # –ù–µ —Å–∂–∏–º–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–ª–æ–∫–∞–º–∏ –∫–æ–¥–∞
    if _contains_code_block(msg.content):
        return msg
    
    try:
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–∂–∞—Ç–∏—è
        prompt = format_compression_prompt(msg.content, content_type)
        
        # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª—å –¥–ª—è —Å–∂–∞—Ç–∏—è
        model = cfg.AGENT_MODELS.get("history_compressor", "deepseek/deepseek-chat")
        
        # –í—ã–∑—ã–≤–∞–µ–º LLM –¥–ª—è —Å–∂–∞—Ç–∏—è
        compressed = await call_llm(
            model=model,
            messages=[{"role": "user", "content": prompt}],
            temperature=0.0,
            max_tokens=2000
        )
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–∂–∞—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        compressed_content = "[COMPRESSED] " + compressed.strip()
        
        # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ª—è –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        compressed_msg = Message(
            id=msg.id,
            thread_id=msg.thread_id,
            role=msg.role,
            content=compressed_content,
            tokens=TokenCounter().count(compressed_content),
            metadata=msg.metadata,
            created_at=msg.created_at
        )
        
        return compressed_msg
        
    except Exception as e:
        logger.warning(f"Compression failed for {msg.role} message: {e}")
        return msg


def prune_irrelevant_context(history: List[Message], current_query: str) -> List[Message]:
    """
    –£–¥–∞–ª—è–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–π–ª–æ–≤,
    —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –≤ —Ç–µ–∫—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ.

    Args:
        history: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
        current_query: –¢–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    Returns:
        –ò—Å—Ç–æ—Ä–∏—è —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º–∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
    """
    # –£–ª—É—á—à–µ–Ω–Ω—ã–π regex –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
    file_pattern = r'[\w/\-]+\.(?:py|js|ts|sql|json|md|txt|html|css|go|java|cpp|c|rs|rb)|\b(?:src|lib|app|tests|config)/[\w/.-]+'
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —É–ø–æ–º—è–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    mentioned_files = set(re.findall(file_pattern, current_query))
    
    # –ï—Å–ª–∏ —Ñ–∞–π–ª—ã –Ω–µ —É–ø–æ–º—è–Ω—É—Ç—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    if not mentioned_files:
        return history
    
    pruned_history = []
    
    for msg in history:
        if msg.role != 'tool':
            pruned_history.append(msg)
        else:
            # –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–π–ª—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            content_files = set(re.findall(file_pattern, msg.content))
            
            # –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:
            # –ï—Å–ª–∏ content_files –ù–ï –ø—É—Å—Ç –ò –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å mentioned_files –ü–£–°–¢–û ‚Üí —ç—Ç–æ –º—É—Å–æ—Ä
            if content_files and not content_files.intersection(mentioned_files):
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
                first_file = next(iter(content_files), "unknown")
                pruned_content = f"[PRUNED: {first_file} –±—ã–ª –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Ä–∞–Ω–µ–µ]"
                pruned_msg = Message(
                    id=msg.id,
                    thread_id=msg.thread_id,
                    role=msg.role,
                    content=pruned_content,
                    tokens=TokenCounter().count(pruned_content),
                    metadata=msg.metadata,
                    created_at=msg.created_at
                )
                pruned_history.append(pruned_msg)
            else:
                # –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ –Ω—É–∂–Ω—ã ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                pruned_history.append(msg)
    
    return pruned_history
```

---

## üìñ –ü–æ—è—Å–Ω–µ–Ω–∏—è –∫ –∫–æ–¥—É

–≠—Ç–æ—Ç –∫–æ–¥ –≤–Ω–æ—Å–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –º–æ–¥—É–ª—å —Å–∂–∞—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤:

1. **–£–¥–∞–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤** - —É–±—Ä–∞–Ω—ã —Å—Ç—Ä–æ–∫–∏ 188-190, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞–ª–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞, —Ç–∞–∫ –∫–∞–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è.

2. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ —Å–∂–∞—Ç–∏—è** - –ø–æ—Ä–æ–≥ —É–≤–µ–ª–∏—á–µ–Ω —Å 8000 –¥–æ 30000 —Ç–æ–∫–µ–Ω–æ–≤. –≠—Ç–æ –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ –∏—Å—Ç–æ—Ä–∏–∏.

3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫–æ–¥–æ–º** - –≤ —Ñ—É–Ω–∫—Ü–∏—é `compress_history_if_needed` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è assistant-—Å–æ–æ–±—â–µ–Ω–∏–π: –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–ª–æ–∫–∏ –∫–æ–¥–∞, –æ–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ —Å–∂–∞—Ç–∏—è —Å –∑–∞–ø–∏—Å—å—é –≤ –ª–æ–≥. –≠—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–∞–∂–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∫–æ–¥–∞ –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º–∏.

4. **–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ `prune_irrelevant_context`**:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–Ω—ã–π regex-–ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –±–æ–ª—å—à–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –∏ –ø—É—Ç–µ–π
   - –õ–æ–≥–∏–∫–∞ –æ–±—Ä–µ–∑–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∞: —Ç–µ–ø–µ—Ä—å —É–¥–∞–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ñ–∞–π–ª—ã, –ù–ï —É–ø–æ–º—è–Ω—É—Ç—ã–µ –≤ —Ç–µ–∫—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ
   - –°–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ —Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
   - –§–æ—Ä–º–∞—Ç –æ–±—Ä–µ–∑–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å—Ç–∞–ª –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º - —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ú–æ–¥—É–ª—å —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- –°–∂–∞—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ 30000 —Ç–æ–∫–µ–Ω–æ–≤
- –ë–ª–æ–∫–∏ –∫–æ–¥–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç —Å–∂–∞—Ç–∏—è
- –û–±—Ä–µ–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞–ª–∞ –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π - —É–¥–∞–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

**–í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ:** –§—É–Ω–∫—Ü–∏–∏ `compress_history_if_needed` –∏ `prune_irrelevant_context` —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω—ã –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–∑–≤–Ω–µ –º–æ–¥—É–ª—è, –∞ –Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ. –≠—Ç–æ –¥–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –≤—Ä–µ–º–µ–Ω–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

---

## üõ†Ô∏è –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

1. ‚úÖ **read_file**
   - –ê—Ä–≥—É–º–µ–Ω—Ç—ã: `file_path=app/history/compressor.py`

---

*–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: 2025-12-14T23:47:30.779485*